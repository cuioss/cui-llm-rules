= CUI Standards Plugin: Architecture
:toc: left
:toclevels: 3
:sectnums:

== Overview

The cui-standards plugin provides centralized development standards, skills, agents, and commands for CUI OSS projects via Claude Code's plugin marketplace.

**Distribution**: Single-command installation via plugin marketplace

**Target Platform**: Claude Code CLI (terminal and VS Code)

== Three-Layer Architecture

=== Layer Model

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ LAYER 1: Skills (Knowledge + Standards)                     │
│ • Self-contained bundles with SKILL.md + standards/        │
│ • Progressive loading: description → workflow → standards   │
│ • Read-only tools recommended                               │
│ • Examples: cui-java-core, cui-documentation                │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ Used by (skill invocation)
                            │ Essential rules embedded from
                            │
┌─────────────────────────────────────────────────────────────┐
│ LAYER 2: Agents (Task Executors)                            │
│ • Autonomous task execution with agent.md                   │
│ • Essential Rules embedded for performance                  │
│ • Invokes skills for complete standards                     │
│ • Examples: project-builder, code-reviewer                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ LAYER 3: Commands (User Utilities)                          │
│ • User-invoked slash commands                               │
│ • Verification and management tools                         │
│ • Examples: /agents-doctor, /cui-setup-project-permissions      │
└─────────────────────────────────────────────────────────────┘

           All layers distributed via single plugin installation
----

=== Layer Responsibilities

**Skills (Layer 1)**: Knowledge and methodology

* Contain standards documentation (AsciiDoc) in `standards/` subdirectory
* Provide workflow instructions in SKILL.md
* Define templates, examples, and checklists
* Self-contained packages with all related standards

**Agents (Layer 2)**: Task execution

* Execute specific development tasks autonomously
* Embed essential rules from skill standards (performance)
* Invoke skills for complete standards when needed
* Use Read, Edit, Write, Bash tools for implementation

**Commands (Layer 3)**: User utilities

* User-invoked verification and management tools
* Examples: doctor commands, setup utilities, validation scripts
* Accessible via `/command-name` syntax

== Key Design Decisions

=== Decision 1: Plugin-Only Distribution

**Approach**: All components distributed via plugin marketplace

**Installation**:
```bash
/plugin marketplace add cuioss/cui-llm-rules
/plugin install cui-standards@cui-llm-rules
```

**Rationale**:

* Single command installation
* Automatic component discovery
* Built-in version management
* No manual file synchronization

**Evidence**: Verified via research - plugins successfully distribute skills, agents, and commands (obra/superpowers, wshobson/agents, 227+ production plugins)

=== Decision 2: Bundled Skills Pattern

**Architecture**: Skills are self-contained bundles with standards in subdirectories

```
skills/cui-java-core/
├── SKILL.md                    # Workflow + logic
└── standards/                  # All related standards
    ├── java-core-standards.adoc
    ├── java-lombok-standards.adoc
    └── logging-standards.adoc
```

**Workflow Pattern**: Skills contain explicit Read instructions

```markdown
### Step 1: Load Applicable Standards

1. **Always load foundational standards**:
   ```
   Read: standards/java-core-standards.adoc
   Read: standards/java-lombok-standards.adoc
   ```

2. **Conditional loading based on context**:
   - If documenting: Read: standards/javadoc-standards.adoc
   - If testing: Read: standards/testing-junit-standards.adoc
```

**Rationale**:

* Self-contained distribution - each skill is complete package
* Reliable loading - explicit Read tool invocation (proven pattern)
* Progressive disclosure - loads only needed standards
* Token efficient - description (30-50 tokens) → SKILL.md (~400 lines) → standards as needed
* Activity-based granularity - 4-6 skills vs 20+ micro-skills

=== Decision 3: Essential Rules Pattern for Agents

**Pattern**: Agents embed core requirements from skill standards while maintaining skill invocation capability

```markdown
# agent.md

## Essential Rules

### Java Standards
Source: skills/cui-java-core/standards/java-core-standards.adoc#key-patterns
Last Synced: 2025-10-23

- All constants must use DSL-style naming (UPPER_SNAKE_CASE)
- All public methods require JavaDoc
- Use @NonNull/@Nullable annotations

## Workflow

For complete standards, invoke cui-java-core skill when needed.
```

**Rationale**:

* **Performance**: Critical requirements immediately available (no I/O delay)
* **Completeness**: Agents can invoke skills for full standards
* **Maintenance**: `/agents-doctor` verifies embedded rules match source
* **Source of Truth**: Skill standards remain authoritative

**Synchronization**: `/agents-doctor sync` verifies and updates embedded rules from skill standards

=== Decision 4: Global Plugin Scope

**Installation Location**: `~/.claude/plugins/marketplaces/cui-llm-rules/`

**Availability**: Global across all projects for user

**Override Hierarchy**:
```
1. Project .claude/      (highest priority)
2. User ~/.claude/
3. Plugin-provided       (lowest priority)
```

**Rationale**: Projects can override specific components while benefiting from global baseline

== Progressive Disclosure Model

=== Skills Loading Sequence

1. **Startup Phase**: Name + description loaded (30-50 tokens)
2. **Context Matching**: Claude determines relevance based on task
3. **Skill Invocation**: Claude loads complete SKILL.md file
4. **Workflow Execution**: Skill workflow instructs Claude to Read standards
5. **Standards Loading**: Claude executes Read tool commands from workflow

**Benefits**:

* Low memory footprint at startup (descriptions only)
* Always current data (reads from source at execution time)
* Efficient resource usage (loads standards only when needed)
* Reliable loading (explicit Read instructions, not passive references)

=== Agents Loading

* **Startup**: Frontmatter metadata loaded
* **Invocation**: Full agent.md loaded with embedded Essential Rules
* **Skill Access**: Agent can invoke skills via Skill tool for complete standards
* **Performance**: Essential Rules provide immediate access to critical requirements

== Platform Support

=== Supported Platforms

* ✅ Claude Code CLI (terminal)
* ✅ Claude Code in VS Code
* ❌ Claude.ai web interface (agents/commands don't exist on web)
* ❌ CI/CD pipelines (plugin installation requires interactive mode)

**Rationale**: Agents and commands are CLI-only features. Plugin distribution provides native integration with Claude Code's component discovery.

== Component Counts

* **Skills**: 8 skills (Java Core, JavaDoc, CDI, Testing, Frontend, Documentation, Project Setup, Requirements)
* **Agents**: 7+ agents for development tasks
* **Commands**: 10+ utility commands
* **Installation**: Single command

== Version Management

=== Update Mechanism

**Updates via marketplace refresh**:
```bash
/plugin marketplace update cui-llm-rules
```

**Note**: No individual plugin update command exists (verified via research)

=== Versioning

* **Format**: Semantic versioning (MAJOR.MINOR.PATCH)
* **Synchronization**: Keep version consistent across:
  - `.claude-plugin/plugin.json`
  - `marketplace.json`
  - Git tags (`vX.Y.Z`)

== Path Resolution

=== Critical Rule: Relative Paths Only

All paths in plugin components **MUST**:

* Be relative to plugin root
* Start with `./`
* Never use absolute paths (`~/...`, `/Users/...`)

**Examples**:
```
✅ CORRECT:
./standards/java/java-core-standards.adoc
./templates/class-template.java

❌ INCORRECT:
~/git/cui-llm-rules/standards/java/java-core-standards.adoc
/Users/oliver/git/cui-llm-rules/standards/...
standards/java/... (missing ./ prefix)
```

=== Environment Variables

**Available**:

* `CLAUDECODE=1` - Indicates Claude Code environment
* `CLAUDE_CODE_ENTRYPOINT=cli` - Platform identifier

**NOT Available**:

* ~~`${CLAUDE_PLUGIN_ROOT}`~~ - This variable does NOT exist (verified)

**For Scripts Requiring Absolute Paths**:

```bash
#!/bin/bash
# Detect plugin root from script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
```

== References

**Official Documentation**:

* Claude Code Plugins: https://docs.claude.com/en/docs/claude-code/plugins
* Plugin Marketplaces: https://docs.claude.com/en/docs/claude-code/plugin-marketplaces
* Skills: https://docs.claude.com/en/docs/claude-code/skills
* Agents: https://docs.claude.com/en/docs/claude-code/sub-agents

**Project Files**:

* Standards: `standards/` (AsciiDoc documentation)
* Technical Specifications: xref:plugin-specifications.adoc[Plugin Specifications]
* Bundling Architecture: xref:bundling-architecture.adoc[Bundling Architecture]
