# Plan Management Persistence

This document specifies the file structure, directory organization, and reference management format for plan files.

## Directory Structure

### Location

**Primary Location**: `.claude/plans/`

**Rationale for .claude/ Directory**:
- ✅ Standard Claude Code directory (not project-specific)
- ✅ Portable across projects
- ✅ Recognized by Claude Code tools
- ✅ Can be git-tracked or git-ignored as needed
- ✅ Consistent with other Claude artifacts (.claude/memory, .claude/scripts)

### Organization

Each plan uses a dedicated subdirectory containing multiple files:

```
.claude/plans/
  └── {task-name}/
      ├── plan.md                        # Tasks only (phases, tasks, status)
      ├── config.md                      # Configuration from init phase
      ├── references.md                  # Reference management and links
      └── implementation-requirements.md # Runtime artifact (generated by refine phase)
```

**Examples**:
```
.claude/plans/jwt-auth/
  ├── plan.md
  ├── config.md
  ├── references.md
  └── implementation-requirements.md     # Generated when refine → implement

.claude/plans/issue-123/
  ├── plan.md
  ├── config.md
  ├── references.md
  └── implementation-requirements.md

.claude/plans/refactor-auth-service/
  ├── plan.md
  ├── config.md
  ├── references.md
  └── implementation-requirements.md
```

### Rationale for Directory Structure

**Why Directory Instead of Single File?**

Unlike `adr-management` (single .adoc file) and `interface-management` (single .adoc file), plans require a directory structure:

- ✅ **Separation of Concerns**: Tasks (plan.md) vs configuration (config.md) vs references (references.md)
- ✅ **Future Expansion**: Can add diagrams, attachments, sub-plans without restructuring
- ✅ **Easier Reference Management**: Dedicated file for ADRs, interfaces, files, issues, branches
- ✅ **Clean Organization**: Complex tasks need structured artifacts
- ✅ **Better Version Control**: Smaller diffs when references change separately from plan

## File Format

### Format Choice: Markdown

**Format**: Markdown (.md)

**Rationale**:
- ✅ Human-readable and manually editable
- ✅ GitHub-compatible rendering
- ✅ Agent-friendly parsing (simple structure)
- ✅ Simple structure (headings, lists, checkboxes)
- ✅ Existing codebase standard (see cui-task-planning skill)
- ✅ Lightweight (no XML overhead like AsciiDoc)
- ✅ Universal tool support

**Why Not AsciiDoc?**
- Plans are simpler than ADRs/interfaces
- No need for advanced formatting (cross-refs, includes)
- Markdown checkboxes are standard for task tracking
- Easier for users to manually edit

## Naming Conventions

### Directory Naming

```
.claude/plans/{task-name}/
```

**Task Name Rules**:
- Lowercase with hyphens (kebab-case)
- Descriptive of task/feature
- Can include issue numbers
- Maximum 50 characters
- Must be valid directory name (no special characters except hyphen)
- No spaces (use hyphens instead)

**Valid Examples**:
- `jwt-auth`
- `issue-123`
- `refactor-auth-service`
- `add-user-permissions`
- `fix-bug-456-memory-leak`

**Invalid Examples**:
- `JWT Auth` (has space)
- `add_user_permissions` (use hyphens, not underscores)
- `refactor/auth/service` (no slashes)
- `very-long-task-name-that-exceeds-the-fifty-character-limit` (too long)

### File Naming

**Fixed Names** (non-configurable):
- `plan.md` - Tasks only (phases, tasks, status)
- `config.md` - Configuration from init phase
- `references.md` - References and links
- `implementation-requirements.md` - Runtime artifact (generated by refine phase)

**Future Extension** (potential):
- `diagram.puml` - PlantUML diagrams
- `attachments/` - Supporting files
- `notes.md` - Additional notes

## File: plan.md

**Key Sections**:
1. Header (title, status, current phase, current task)
2. Phase Progress Table
3. Phase sections with tasks
4. Completion Criteria

**Minimal Design**: plan.md contains ONLY task-related content. All configuration is in config.md, all references are in references.md.

See [Templates & Workflow](../templates-workflow.md) for complete template and structure.

## File: config.md

**Key Sections**:
```markdown
# Configuration

**Plan Type**: {implementation|simple}

---

## Build Configuration

| Property | Value |
|----------|-------|
| Technology | {java|javascript|mixed|none} |
| Build System | {maven|gradle|npm|npx|none} |

---

## Workflow Configuration

| Property | Value |
|----------|-------|
| Compatibility | {breaking|deprecations} |
| Commit Strategy | {fine-granular|phase-specific|complete} |
| Finalizing | {commit-only|pr-workflow} |

---

## Context

| Property | Value |
|----------|-------|
| Branch | {branch-name} |
| Issue | {issue-reference or "none"} |

---

**Generated by**: plan-init skill
```

**Field Descriptions**:

| Field | Description | Values |
|-------|-------------|--------|
| Technology | Primary programming language | java, javascript, mixed, none |
| Build System | Build tool to use | maven, gradle, npm, npx, none |
| Compatibility | Breaking change policy | breaking, deprecations |
| Commit Strategy | When to commit | fine-granular, phase-specific, complete |
| Finalizing | How to finalize work | commit-only, pr-workflow |
| Branch | Git branch for work | Any valid branch name |
| Issue | Linked issue reference | Issue URL/ID or "none" |

**Lifecycle**:
- Created: By plan-init skill during init phase (via `plan-files.write-config`)
- Read: Via `plan-files` skill `read-config` operation
- Updated: Rarely (only if configuration changes)
- Archived: With plan when finalized

## File: references.md

### Structure

```markdown
# References

## Issue

**GitHub Issue**: [#123 - Add JWT Authentication](https://github.com/org/repo/issues/123)

**Branch**: `feature/jwt-auth`

## Related Files

**Implementation Files**:
- `src/main/java/com/example/auth/JwtService.java`
- `src/main/java/com/example/auth/TokenValidator.java`
- `src/test/java/com/example/auth/JwtServiceTest.java`

**Configuration Files**:
- `src/main/resources/application.properties` (JWT settings)

## Architecture Decision Records (ADRs)

**Related ADRs** (managed via `adr-management` skill):
- [ADR-015: JWT Authentication Strategy](.claude/adrs/ADR-015-jwt-authentication-strategy.adoc)
- [ADR-020: Token Storage Mechanism](.claude/adrs/ADR-020-token-storage-mechanism.adoc)

**To create new ADR**: Use `adr-management` skill operations
**To read ADR**: Use `adr-management` skill with ADR identifier

## Interface Specifications

**Related Interfaces** (managed via `interface-management` skill):
- [IF-042: Authentication Service Interface](doc/interfaces/IF-042-authentication-service.adoc)
- [IF-051: Token Validation Interface](doc/interfaces/IF-051-token-validation.adoc)

**To create new interface**: Use `interface-management` skill operations
**To read interface**: Use `interface-management` skill with interface identifier

## External Documentation

**Standards and Specifications**:
- [RFC 7519: JSON Web Token (JWT)](https://datatracker.ietf.org/doc/html/rfc7519)
- [OWASP JWT Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html)

**Libraries and Tools**:
- [JJWT Library Documentation](https://github.com/jwtk/jjwt)

## Dependencies

**Maven Dependencies**:
- `io.jsonwebtoken:jjwt-api:0.11.5`
- `io.jsonwebtoken:jjwt-impl:0.11.5`
- `io.jsonwebtoken:jjwt-jackson:0.11.5`

**Related Plans**:
- `.claude/plans/user-authentication/plan.md` (prerequisite)
- `.claude/plans/api-security/plan.md` (related)
```

### Reference Types

#### 1. Issue and Branch

**Format**:
```markdown
**GitHub Issue**: [#123 - Add JWT Authentication](https://github.com/org/repo/issues/123)
**Branch**: `feature/jwt-auth`
```

**Use Cases**:
- Track issue implementation status
- Link PR to plan
- Reference in commit messages

#### 2. Local Files

**Categories**:
- Implementation Files: Source code files
- Configuration Files: Config files (properties, yaml, json)
- Test Files: Test source files

**Format**:
```markdown
**Implementation Files**:
- `path/to/file1.java`
- `path/to/file2.java`

**Configuration Files**:
- `path/to/config.properties` (description)

**Test Files**:
- `path/to/test/file1Test.java`
```

**Use Cases**:
- Quick overview of scope
- Verification checklist
- File change tracking

#### 3. ADRs (Architectural Decision Records)

**Skill Integration**:
- Use `adr-management` skill to verify ADR exists
- Use `adr-management` skill to create new ADRs
- Use `adr-management` skill to read ADR content

**Format**:
```markdown
**Related ADRs** (managed via `adr-management` skill):
- [ADR-015: JWT Authentication Strategy](.claude/adrs/ADR-015-jwt-authentication-strategy.adoc)

**To create new ADR**: Use `adr-management` skill operations
**To read ADR**: Use `adr-management` skill with ADR identifier
```

**Workflow**:
1. Plan references ADR-015
2. Phase skill (via `plan-files`) calls `adr-management` skill to verify ADR exists
3. If ADR doesn't exist, optionally create it
4. Add reference via `plan-files.write-references`

See [Architecture](../architecture.md#reference-management-integration) for skill integration details.

#### 4. Interface Specifications

**Skill Integration**:
- Use `interface-management` skill to verify interface exists
- Use `interface-management` skill to create new interfaces
- Use `interface-management` skill to read interface content

**Format**:
```markdown
**Related Interfaces** (managed via `interface-management` skill):
- [IF-042: Authentication Service Interface](doc/interfaces/IF-042-authentication-service.adoc)

**To create new interface**: Use `interface-management` skill operations
**To read interface**: Use `interface-management` skill with interface identifier
```

**Workflow**:
1. Plan references IF-042
2. Phase skill (via `plan-files`) calls `interface-management` skill to verify interface exists
3. If interface doesn't exist, optionally create it
4. Add reference via `plan-files.write-references`

See [Architecture](../architecture.md#reference-management-integration) for skill integration details.

#### 5. External Documentation

**Categories**:
- Standards and Specifications (RFCs, W3C, ISO, etc.)
- Library Documentation (official docs, GitHub repos)
- Best Practices Guides (OWASP, security guidelines)

**Format**:
```markdown
**Standards and Specifications**:
- [RFC 7519: JSON Web Token (JWT)](https://datatracker.ietf.org/doc/html/rfc7519)

**Libraries and Tools**:
- [JJWT Library Documentation](https://github.com/jwtk/jjwt)
```

**Use Cases**:
- Quick access to reference materials
- Standard compliance verification
- Implementation guidance

#### 6. Dependencies

**Subcategories**:
- Maven/npm dependencies (with versions)
- Related plans (prerequisites, dependencies)

**Format**:
```markdown
**Maven Dependencies**:
- `group:artifact:version`

**NPM Dependencies**:
- `package@version`

**Related Plans**:
- `.claude/plans/other-plan/plan.md` (prerequisite|related)
```

**Use Cases**:
- Dependency tracking
- Version management
- Plan orchestration
- Prerequisite verification

## File: implementation-requirements.md

**Generation**: Created when refine phase transitions to implement phase

**Template**: See [plan-refine/implementation-requirements-template.md](../plan-refine/implementation-requirements-template.md)

### Structure

```markdown
# Implementation Requirements: {Task Title}

**Generated**: {date}
**Plan**: .claude/plans/{task-name}/
**Phase Transition**: refine → implement

---

## Overview

{Brief description of implementation scope}

**Configuration**: Access via `plan-files` skill `read-config` operation (technology, build-system, compatibility stored in config.md)

---

## Component Summary

| Component | Scope | Complexity | Tasks |
|-----------|-------|------------|-------|
| {name} | {description} | {low/med/high} | {task-ids} |

---

## Task Details

### Task {N}: {Task Title}

**Dependencies**: {task-ids or "none"}

#### Goal

{Clear description of what success looks like}

#### Implementation Guidance

{Specific technical guidance}

#### Files

| Action | Path | Description |
|--------|------|-------------|
| Create | {path} | {purpose} |
| Modify | {path} | {changes} |

#### Acceptance Criteria

- [ ] {Criterion 1}
- [ ] {Criterion 2}

---

## Dependency Graph

{Visual representation of task dependencies}

---

## References

### Issue
- **URL**: {issue-url}
- **Title**: {issue-title}

### Architecture Decision Records
| ADR | Title | Relevance |
|-----|-------|-----------|
| {ADR-NNN} | {title} | {relevance} |

### Interface Specifications
| Interface | Title | Relevance |
|-----------|-------|-----------|
| {IF-NNN} | {title} | {relevance} |

---

## Quality Gates

{Build verification, coverage checks, documentation checks}

---

**Generated by**: plan-refine skill
```

### Content Source

| Section | Source |
|---------|--------|
| Overview | plan.md configuration |
| Component Summary | Refine phase analysis |
| Task Details | Refine phase task planning |
| Dependency Graph | Refine phase dependency mapping |
| References | Via skill operations (not duplicated, no direct file access) |
| Quality Gates | Technology-specific standards |

**Reference Access**: The implementation-requirements.md does NOT duplicate reference content or access files directly. All access via skill operations:
- ADRs: Use `adr-management` skill
- Interfaces: Use `interface-management` skill
- Issue, files, docs, dependencies: Use `plan-files` skill `get-references` operation

### Lifecycle

| Event | Action |
|-------|--------|
| Refine phase completes | Generate implementation-requirements.md |
| Task modified during implement | Update relevant task section |
| Plan finalized | Archive with completed status |

## File Operations

All file operations are handled by the **`plan-files` skill**. See [plan-files.md](plan-files.md) for complete operation documentation, or [API Specification](../api.md#skill-plan-files) for TOON handoffs.

### Creating Plan Directory

**Skill Operation**: `plan-files.create-directory`
**Tool**: `Bash` (`mkdir -p .claude/plans/{task-name}/`)

### Creating Files

**Skill Operations**:
- `plan-files.write-plan` → Create `plan.md`
- `plan-files.write-config` → Create `config.md`
- `plan-files.write-references` → Create `references.md`

**Content**: Generated from templates (see [Templates & Workflow](../templates-workflow.md))

### Reading Files

**Skill Operations**:
- `plan-files.read-plan` → Read `plan.md` (tasks, phases, status)
- `plan-files.read-config` → Read `config.md` (technology, build system, etc.)
- `plan-files.get-references` → Read `references.md` (ADRs, interfaces, files)

### Updating Files

**Skill Operations**:
- `plan-files.update-progress` → Mark tasks complete, update phase status, update Phase Progress Table
- `plan-files.write-plan` → Modify plan structure
- `plan-files.write-references` → Add/modify references

## Version Control

### Git Tracking

**Recommendation**: Git-track plan directories

**Rationale**:
- Plans are project artifacts
- Track plan evolution over time
- Link plan changes to code changes
- Enable plan review in PRs

**.gitignore Consideration**:
```
# Track plans
!.claude/plans/

# Optionally ignore in-progress plans
.claude/plans/*/temp-*.md
```

### Commit Message Format

When committing plan changes:
```
docs(plan): update jwt-auth plan with phase 2 tasks

- Added 3 implementation tasks to phase 2
- Updated Phase Progress Table
- Added references to ADR-015 and IF-042
```

## Summary

The persistence layer provides:

1. ✅ **Organized Structure** - Directory-based with plan.md + config.md + references.md + implementation-requirements.md
2. ✅ **Clear Separation** - Tasks (plan.md) vs configuration (config.md) vs references vs implementation guidance
3. ✅ **Markdown Format** - Human-readable and tool-friendly
4. ✅ **Consistent Naming** - Kebab-case task names
5. ✅ **Reference Management** - Integrated with adr-management and interface-management
6. ✅ **Runtime Artifacts** - implementation-requirements.md generated by refine phase
7. ✅ **Version Control** - Git-trackable artifacts
8. ✅ **Future-Proof** - Extensible without breaking changes
9. ✅ **Skill-Based Access** - All file access via `plan-files` skill (read-plan, read-config, get-references, etc.)

---

**Related Documents**:
- [plan-files Skill](plan-files.md) - Skill operations specification
- [Plan Types](../plan-types.md) - Init phase router
- [Refine Phase](../plan-refine/refine.md) - Refine phase specification
- [Implement Phase](../plan-implement/implement.md) - Implement phase specification
- [Implementation Requirements Template](../plan-refine/implementation-requirements-template.md) - Runtime artifact template
- [Architecture](../architecture.md) - Abstraction layer design
- [Templates & Workflow](../templates-workflow.md) - plan.md template and phase workflow
- [API Specification](../api.md) - File operation APIs
