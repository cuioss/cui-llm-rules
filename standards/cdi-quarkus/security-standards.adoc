= CDI and Quarkus Security Standards
:toc: left
:toclevels: 3
:sectnums:

== Purpose

This document defines security standards and best practices for CDI and Quarkus applications, focusing on container security, OWASP compliance, and enterprise-grade security implementations within CUI projects.

== Related Documentation

* xref:container-standards.adoc[Container Standards]: Comprehensive container standards with security configurations
* xref:docker-health-check-best-practices.adoc[Docker Health Check Best Practices]: Secure health check implementations
* xref:README.adoc[CDI and Quarkus Standards Overview]: Main standards directory

== Container Security Standards

=== Production Security Requirements

==== Security-Hardened Base Images
* **Production Default**: Quarkus distroless base image (91.9MB)
* **Security Benefits**: Minimal attack surface, no shell access, no package manager
* **Compliance**: OWASP Docker Top 10 aligned
* **Performance**: <0.5s startup, <150MB memory, <100MB image size

==== Development Security
* **Development Alternative**: UBI9 minimal for debugging (219MB)
* **Use Cases**: Debugging, troubleshooting, educational purposes
* **Security Constraints**: Should not be used in production environments

=== Security-Hardened Dockerfile Standards

==== OWASP-Compliant Dockerfile Template
[source,dockerfile]
----
# Security-hardened Quarkus native container
FROM quay.io/quarkus/quarkus-distroless-image:2.0

# Security metadata (OWASP compliance)
LABEL security.scan.required="true"
LABEL security.distroless="true"
LABEL org.opencontainers.image.vendor="CUI"
LABEL org.opencontainers.image.title="Application Name"
LABEL org.opencontainers.image.description="Security-hardened Quarkus application"

WORKDIR /app

# Secure copy operations with explicit ownership and permissions
COPY --chmod=0755 --chown=nonroot:nonroot target/*-runner /app/application
COPY --chmod=0755 --chown=nonroot:nonroot health-check.sh /app/health-check.sh
COPY --chmod=0644 --chown=nonroot:nonroot certificates/ /app/certificates/

# Expose HTTPS port only (no HTTP for security)
EXPOSE 8443

# Health check using internal script (no external dependencies)
HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=40s \
  CMD /app/health-check.sh

# Non-root execution (OWASP requirement)
USER nonroot

# Use exec form for better signal handling and security
ENTRYPOINT ["/app/application"]
----

==== Security Features Explained
* **Distroless Base**: Minimal attack surface with no shell or package manager
* **Security Labels**: Enable automated scanning and compliance tracking
* **Non-Root User**: Prevents privilege escalation attacks
* **Secure Permissions**: Minimal necessary file permissions (755 for executables, 644 for configs)
* **Explicit Ownership**: All files owned by `nonroot:nonroot`
* **HTTPS Only**: No HTTP endpoints exposed for security
* **Internal Health Checks**: No external dependencies like `curl`

=== Runtime Security Configuration

==== Production Security Command Template
[source,bash]
----
# OWASP-compliant production deployment
docker run -d \
  --security-opt=no-new-privileges \
  --cap-drop ALL \
  --read-only \
  --tmpfs /tmp:rw,noexec,nosuid,size=100m \
  --tmpfs /app/tmp:rw,noexec,nosuid,size=50m \
  --memory="256m" \
  --cpus="1.0" \
  --restart=unless-stopped \
  -v "./certificates:/app/certificates:ro" \
  application:latest
----

==== Security Options Breakdown
* **`--security-opt=no-new-privileges`**: Prevents privilege escalation via setuid/setgid binaries
* **`--cap-drop ALL`**: Removes all Linux capabilities (principle of least privilege)
* **`--read-only`**: Makes root filesystem read-only (immutable infrastructure)
* **`--tmpfs`**: Provides temporary writable space without persistence
* **`--memory/--cpus`**: Resource limits prevent DoS attacks
* **`--restart=unless-stopped`**: Production resilience without security risks

=== Docker Compose Security Configuration

==== Security-Hardened Compose Template
[source,yaml]
----
version: '3.8'

services:
  application:
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.native
    ports:
      - "external-port:8443"
    volumes:
      # Read-only certificate mount for security
      - ./certificates:/app/certificates:ro
    environment:
      - QUARKUS_LOG_LEVEL=INFO
    
    # OWASP Security hardening configuration
    security_opt:
      - no-new-privileges:true
    
    # Drop all capabilities (principle of least privilege)
    cap_drop:
      - ALL
    
    # Read-only filesystem with tmpfs for temporary files
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
      - /app/tmp:rw,noexec,nosuid,size=50m
    
    # Resource limitations (DoS protection)
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    
    # Health check using internal script
    healthcheck:
      test: ["CMD", "/app/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Network isolation
    networks:
      - app-security-network
    
    # Production restart policy
    restart: unless-stopped

networks:
  app-security-network:
    driver: bridge
    # Control inter-container communication
    internal: false
----

== Security Compliance Standards

=== OWASP Docker Top 10 Compliance Checklist

==== Critical Security Requirements (Production Mandatory)
- [ ] **D01 - Secure User Mapping**: Distroless base with explicit non-root user (`USER nonroot`)
- [ ] **D02 - Patch Management**: Regular base image updates and vulnerability scanning in CI/CD
- [ ] **D03 - Network Hardening**: HTTPS-only endpoints, proper network isolation
- [ ] **D04 - Security Defaults**: Read-only filesystem, no-new-privileges, capability dropping
- [ ] **D05 - Maintain Security Contexts**: Proper file permissions and ownership
- [ ] **D06 - Resource Protection**: Memory/CPU limits, DoS prevention measures
- [ ] **D07 - Data Protection**: Secure certificate management, no embedded secrets
- [ ] **D08 - Container Monitoring**: Health checks without external dependencies
- [ ] **D09 - Version Pinning**: Specific base image versions (never use `latest`)
- [ ] **D10 - Secrets Management**: External secret stores, not embedded in images

=== Security Verification Procedures

==== Container Security Validation
[source,bash]
----
# Verify container security configuration
docker inspect container --format='User: {{.Config.User}}'
docker inspect container --format='SecurityOpt: {{.HostConfig.SecurityOpt}}'
docker inspect container --format='ReadOnly: {{.HostConfig.ReadonlyRootfs}}'

# Test application functionality with security hardening
curl -k https://localhost:8443/q/health/live  # Should return 200

# Performance verification (should be < 0.5s)
docker logs container | grep "started in"

# Resource usage verification
docker stats container --no-stream
----

==== Security Performance Metrics (Verified)
* **Image Size**: 91.9MB (58% reduction from UBI9 baseline)
* **Startup Time**: 0.167s (maintained with security hardening)
* **Memory Usage**: <150MB (within security resource limits)
* **Attack Surface**: Minimal (distroless + no shell access)
* **Privilege Level**: Non-root execution only
* **Compliance**: OWASP Docker Top 10 fully aligned

=== Certificate Security Management

==== Production Certificate Standards
* **External Mounting**: Use read-only certificate mounts (`-v ./certs:/app/certificates:ro`)
* **Rotation Policy**: 1 day validity for testing, maximum 90 days for production
* **Storage Security**: Proper permissions (0644) with secure ownership (`nonroot:nonroot`)
* **Format Requirements**: PKCS12 format for keystores and truststores
* **Zero Embedding**: Never include certificates in container images
* **Automated Validation**: Health checks verify certificate availability and readability

==== Certificate Security Implementation
[source,dockerfile]
----
# Secure certificate handling
COPY --chmod=0644 --chown=nonroot:nonroot certificates/ /app/certificates/

# Production deployment with external certificates
# docker run -v "./secure-certs:/app/certificates:ro" application
----

== Health Check Security Standards

=== Secure Health Check Implementation

==== Internal Health Check Requirements
* **No External Dependencies**: Avoid `curl`, `wget`, or similar tools
* **Direct Port Testing**: Use `/dev/tcp` for connectivity verification
* **Application-Specific Validation**: Check certificates, executables, and critical resources
* **Fast Execution**: Health checks should complete in <10 seconds
* **Error Handling**: Clear error messages for troubleshooting

==== Secure Health Check Script Template
[source,bash]
----
#!/bin/bash
# Secure internal health check script

# Direct port connectivity test (no external tools)
if ! echo -n '' > /dev/tcp/127.0.0.1/8443 2>/dev/null; then
    echo "Application not listening on port 8443"
    exit 1
fi

# Validate critical security resources
if [ ! -r "/app/certificates/keystore.p12" ]; then
    echo "Certificate files missing or not readable"
    exit 1
fi

if [ ! -x "/app/application" ]; then
    echo "Application executable missing or not executable"
    exit 1
fi

echo "Security health check passed"
exit 0
----

=== Health Check Security Benefits
* **No Attack Surface**: Internal scripts don't expose additional services
* **Distroless Compatible**: Works without shell commands or external tools
* **Resource Efficient**: Minimal overhead and fast execution
* **Security Validation**: Verifies security-critical resources are accessible
* **Production Ready**: Suitable for high-security environments

== Logging Security Standards

=== Secure Logging Configuration

==== Console-Only Logging (Required)
* **No File Logging**: All applications must use console logging only
* **Security Rationale**: Prevents log file access and reduces attack surface
* **Container Compatibility**: Works with read-only filesystems
* **Monitoring Integration**: Compatible with centralized logging systems

==== Secure Logging Configuration
[source,properties]
----
# Console logging configuration (security compliant)
quarkus.log.console.enable=true
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
quarkus.log.level=INFO

# Debug levels for application-specific packages only
quarkus.log.category."de.cuioss.jwt".level=DEBUG

# SECURITY: Never log sensitive data
# - No authentication tokens
# - No certificate contents
# - No internal system information
----

=== Logging Security Requirements
* **No Sensitive Data**: Never log tokens, passwords, or certificate contents
* **Structured Format**: Use consistent, parseable log formats
* **Appropriate Levels**: INFO for operations, DEBUG only for development
* **Centralized Collection**: Use external log aggregation systems
* **Retention Policies**: Follow organizational data retention requirements

== Security Monitoring and Compliance

=== Continuous Security Monitoring

==== Required Security Metrics
* **Container Resource Usage**: Monitor CPU and memory consumption
* **Application Startup Time**: Verify performance isn't degraded by security
* **Health Check Response Times**: Ensure health checks remain responsive
* **Error Rates**: Monitor application and security-related errors
* **Certificate Expiration**: Automated certificate lifecycle monitoring

==== Security Scanning Requirements
* **Image Vulnerability Scanning**: Integrate Trivy, Snyk, or similar tools in CI/CD
* **Runtime Security Monitoring**: Monitor for privilege escalation attempts
* **Network Traffic Analysis**: Ensure only HTTPS traffic is allowed
* **Resource Usage Monitoring**: Detect potential DoS attacks
* **Compliance Verification**: Regular OWASP Top 10 compliance checks

=== Enterprise Security Standards

==== Production Security Requirements
* **Regular Security Assessments**: Quarterly penetration testing
* **Incident Response**: Defined procedures for security incidents
* **Compliance Auditing**: Regular OWASP and industry standard compliance verification
* **Security Training**: Team training on container security best practices
* **Documentation**: Maintain security configuration documentation and runbooks

==== Security Governance
* **Security Reviews**: All container configurations must pass security review
* **Change Control**: Security configuration changes require approval
* **Monitoring**: Continuous monitoring for security policy violations
* **Reporting**: Regular security posture reporting to stakeholders

This security standards document provides comprehensive guidance for implementing enterprise-grade security in CDI and Quarkus applications, ensuring OWASP compliance and industry best practices are consistently applied across all CUI projects.