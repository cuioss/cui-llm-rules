= CUI LLM Rules: Plugin Architecture Overview
:toc: left
:toclevels: 3
:sectnums:

== Introduction

This document describes the architectural design of the cui-llm-rules Claude Code plugin, which provides centralized standards, skills, agents, and commands for CUI (Common User Interface) OSS projects.

== Executive Summary

The cui-llm-rules repository transforms from a documentation-only repository into a Claude Code plugin that provides a four-layer architecture:

* **Standards**: Authoritative technical requirements (existing AsciiDoc documentation)
* **Skills**: Knowledge layers that reference standards and provide methodologies
* **Agents**: Task executors that use skills and embedded essential rules
* **Commands**: User-invoked utilities for verification and management

All layers are distributed via a single plugin installation, eliminating manual synchronization.

== Four-Layer Architecture Model

=== Layer Overview

----
Layer 1: Standards (AsciiDoc) - Source of truth
Layer 2: Skills (SKILL.md) - Knowledge & methodology (references Layer 1)
Layer 3: Agents (agent.md) - Task executors (use Layer 2, embed essential rules from Layer 1)
Layer 4: Commands (command.md) - User utilities
----

=== Visual Architecture

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ LAYER 1: Standards (Source of Truth)                        │
│ Location: cui-llm-rules/standards/                          │
│ Format: AsciiDoc (.adoc)                                    │
│ Purpose: Define technical requirements                      │
│                                                              │
│ Examples:                                                    │
│ • java/java-code-standards.adoc                             │
│ • testing/core-standards.adoc                               │
│ • documentation/javadoc-standards.adoc                      │
│ • process/task-completion-standards.adoc                    │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ Referenced by (dynamic reads)
                            │
┌─────────────────────────────────────────────────────────────┐
│ LAYER 2: Skills (Knowledge & Methodology)                   │
│ Location: cui-llm-rules/skills/                             │
│ Format: SKILL.md with YAML frontmatter                      │
│ Purpose: Provide Claude with context and methodology        │
│                                                              │
│ Examples:                                                    │
│ • cui-java-standards/SKILL.md                               │
│   - Reads standards/java/*.adoc dynamically                 │
│   - Provides quick reference, templates, examples           │
│   - allowed-tools: Read                                     │
│                                                              │
│ • cui-testing-methodology/SKILL.md                          │
│ • cui-documentation-standards/SKILL.md                      │
│ • cui-process-standards/SKILL.md                            │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ Used by (skills referenced in prompts)
                            │
                            │ Embedded essential rules (synced via agents-doctor)
                            │ from Layer 1
                            │
┌─────────────────────────────────────────────────────────────┐
│ LAYER 3: Agents (Task Executors)                            │
│ Location: cui-llm-rules/agents/                             │
│ Format: agent.md with YAML frontmatter                      │
│ Purpose: Autonomous task execution                          │
│                                                              │
│ Pattern: Essential Rules (embedded) + Skill References      │
│                                                              │
│ Examples:                                                    │
│ • project-builder.md                                        │
│   - System prompt: "Read cui-java-standards skill"          │
│   - Essential Rules: Embedded JavaDoc/testing requirements  │
│   - Tools: Read, Edit, Write, Bash                          │
│                                                              │
│ • code-reviewer.md                                          │
│ • adoc-review.md                                            │
│ • test-generator.md                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ LAYER 4: Commands (User Utilities)                          │
│ Location: cui-llm-rules/commands/                           │
│ Format: Markdown                                            │
│ Purpose: User-invoked utilities and verification            │
│                                                              │
│ Examples:                                                    │
│ • agents-doctor.md - Verify agents, sync essential rules    │
│ • slash-doctor.md - Verify commands                         │
│ • setup-project-permissions.md                              │
└─────────────────────────────────────────────────────────────┘

           ▲
           │ All layers distributed via Plugin
           │
┌──────────┴──────────────────────────────────────────────────┐
│ PLUGIN: cui-standards                                        │
│ Installation: /plugin install cui-standards@cui-llm-rules   │
│ Updates: /plugin marketplace update cui-llm-rules           │
└─────────────────────────────────────────────────────────────┘
----

== Key Architectural Decisions

=== Decision 1: Skills Reference Standards (Not Embed)

* **Rationale**: Standards are authoritative source, skills provide access layer
* **Implementation**: Skills use Read tool to dynamically fetch from `standards/`
* **Benefit**: No duplication between skills, always current

==== Skills Access Mechanism

[WARNING]
====
**⚠️ PROPOSED MECHANISM - REQUIRES VERIFICATION**

The Claude.ai web and CI/CD access mechanism documented below is an **unverified assumption that could break the core cross-platform architecture if incorrect**.

**Verification Status**: ❌ Not tested

**See**: xref:research-topics.adoc#_1_skills_access_from_claudeai_web[Research Topics § Skills Access from Claude.ai Web] for:

* Test scenarios and acceptance criteria
* Alternative approaches if this assumption fails
* Architectural impact assessment

**Do NOT implement** based on this section alone. Verification must be completed first.
====

**If this mechanism works as proposed**, skills would be accessed dynamically at runtime using the following mechanism:

**When Claude Code is Running:**

1. **Plugin Installation Provides Skills**
   * Skills remain in plugin directory: `~/.claude/plugins/cui-standards/skills/`
   * Claude loads skill metadata (name, description) at startup
   * Full skill content loaded via Read tool when needed
   * Skills use relative paths (`./standards/...`) which resolve against plugin root

2. **Agent References in Synchronized .claude/ Files**
   * Agents synchronized to `.claude/agents/` contain prompts like: "Read cui-java-standards skill"
   * Claude resolves skill name to plugin installation path
   * Reads `~/.claude/plugins/cui-standards/skills/cui-java-standards/SKILL.md`
   * Skill then reads standards files via relative paths

**When Using Claude.ai Web or CI/CD (No Plugin Support) - PROPOSED:**

1. **Agents Are Git-Controlled** ✅ (Verified mechanism)
   * Project has `.claude/agents/` with synchronized agents (committed to git)
   * Agents reference skills by name in their prompts

2. **Skills Must Be Accessible via Repository** ⚠️ (Unverified - see research-topics.adoc)
   * **Public Repository - PROPOSED**: Claude can access via GitHub API/web fetch
     - Repository URL: `https://github.com/cuioss/cui-llm-rules`
     - Skill path: `skills/cui-java-standards/SKILL.md`
     - Standards path: `standards/java/java-code-standards.adoc`

   * **Private/Offline Repository - MECHANISM UNKNOWN**: See xref:research-topics.adoc#_5_private_repository_access[Research Topics § Private Repository Access]
     - **Possible approaches** (all unverified):
       * Clone repository to accessible location
       * Configure path in project `.claude/settings.json` (if this field exists)
       * Reference local clone path in agent prompts
       * Require repository to be public

3. **Resolution Flow**
   ```
   Agent prompt: "Read cui-java-standards skill from https://github.com/cuioss/cui-llm-rules"
   → Claude fetches: https://github.com/cuioss/cui-llm-rules/skills/cui-java-standards/SKILL.md
   → Skill references: ./standards/java/java-code-standards.adoc
   → Claude fetches: https://github.com/cuioss/cui-llm-rules/standards/java/java-code-standards.adoc
   ```

**Critical Requirements (if mechanism works as proposed):**

* **Repository must be public** OR agents must include explicit repository URLs (mechanism unverified)
* **Skills never synchronized** to `.claude/` (to avoid drift) - unless verification fails, see xref:research-topics.adoc#_1_skills_access_from_claudeai_web[alternative approaches]
* **Standards files must be accessible** via same mechanism as skills (unverified)
* **Relative path resolution** must work when Claude fetches from repository root (unverified)

=== Decision 2: Agents Use Essential Rules Pattern (Custom Implementation)

**Overview**: Agents embed core requirements from standards for performance while maintaining skill references for complete information.

* **Important**: This is a **custom pattern**, not a native Claude Code feature
* **Rationale**: Performance (no I/O during execution), autonomy (self-contained during task execution)
* **Trade-off**: Duplication accepted for speed and reliability
* **Mitigation**: Synchronization and drift detection via `/agents-doctor sync` command (custom implementation requiring manual approval)

**Pattern Structure**: Agents contain two knowledge layers:

1. **Essential Rules**: Embedded core requirements (5-15 critical rules per domain)
2. **Skill References**: Prompts that direct Claude to read skills for complete standards

**For complete specification** including implementation details, synchronization workflow, and drift detection mechanisms, see xref:component-specifications.adoc#essential-rules-pattern-custom-implementation[Component Specifications § Essential Rules Pattern].

=== Decision 3: Plugin-Based Distribution

* **Rationale**: Native Claude Code mechanism, no manual copying
* **Implementation**: cui-llm-rules becomes installable plugin
* **Benefit**: Version control, team consistency, automatic updates

=== Decision 4: Project-Specific Overrides Allowed

* **Rationale**: Projects may need specialized skills/agents
* **Implementation**: `.claude/skills/` and `.claude/agents/` override plugin
* **Benefit**: Global defaults + project customization

== Progressive Disclosure Model

=== Skills Loading Pattern

Skills utilize progressive disclosure as validated by research:

. **Startup Phase**: Name + description loaded (30-50 tokens)
. **Context Matching**: Claude determines relevance based on task
. **Dynamic Fetch**: Read tool loads `SKILL.md` and referenced files only when needed

This pattern ensures:

* Low memory footprint at startup
* Current data always (read from source)
* Efficient resource usage

=== Conflict Resolution Hierarchy

Project-level files take precedence over plugin-provided files:

----
Priority: Project .claude/ > User ~/.claude/ > Plugin-provided
----

For nested CLAUDE.md files, the most specific (deepest nested) takes priority.

== Installation and Updates

See xref:plugin-structure.adoc#installation[Plugin Structure § Installation] for complete installation instructions and xref:plugin-structure.adoc#version-management[Plugin Structure § Version Management] for version management details.

== Version Management (Summary)

* **Version Field**: Defined in `.claude-plugin/plugin.json` and `marketplace.json`
* **Git Tags**: Used for version tracking (e.g., `v1.0.0`, `v1.1.0`)
* **Semantic Versioning**: Standard semver format (MAJOR.MINOR.PATCH)
* **Distribution**: Via marketplace refresh
* **Limitation**: No explicit version pinning mechanism in Claude Code (as of research date)

=== Skills Versioning Strategy

**Key principle**: Skills are **always accessed from repository HEAD** (latest version), not pinned to plugin version.

==== Versioning Behavior by Platform

**Claude Code (Plugin Installed)**:

* Skills loaded from: `~/.claude/plugins/cui-standards/skills/` (plugin installation)
* Version: Matches installed plugin version
* Update: When plugin updates (via marketplace refresh)

**Claude.ai Web & CI/CD** (⚠️ mechanism unverified):

* Skills accessed from: Repository URL (e.g., GitHub)
* Version: **Always latest** (HEAD of default branch)
* Update: Automatic (fetches from repository at runtime)
* **Implication**: Web users get latest skills even if plugin version is older

==== Version Consistency Implications

**Scenario**: Plugin v1.0.0 installed, but repository has newer standards

|===
|Platform |Skills Version |Standards Version |Consistent?

|**Claude Code**
|v1.0.0 (from plugin)
|v1.0.0 (via skills)
|✅ Yes

|**Claude.ai Web** (if access works)
|Latest (from repo)
|Latest (from repo)
|✅ Yes

|**Mixed team** (some CLI, some web)
|Mixed (v1.0.0 + latest)
|Mixed
|⚠️ **Inconsistent**
|===

==== Recommendations

**For consistent team experience**:

1. **Keep plugin updated**: Claude Code users should update plugin when standards change
   ```bash
   /plugin marketplace update cui-llm-rules
   ```

2. **Document standards version**: In `standards/README.adoc`, note current version
   ```adoc
   = CUI Standards
   Version: 1.2.0 (matches plugin version)
   Last Updated: 2025-10-22
   ```

3. **Breaking changes**: When standards have breaking changes:
   * Bump plugin MAJOR version
   * Document migration guide
   * Test agents with new standards before release

4. **Accept eventual consistency**: Web users always get latest; CLI users get plugin version. This is acceptable if changes are backward-compatible.

==== Skills vs Agents vs Standards Versioning

[cols="1,2,2"]
|===
|Component |Versioning Strategy |Rationale

|**Standards** (Layer 1)
|Git-tracked, references in skills
|Source of truth, versioned via git

|**Skills** (Layer 2)
|Dynamic fetch, always latest
|Mediates access to standards, should match standards version

|**Agents** (Layer 3)
|Synchronized to project, versioned via git
|Project-specific, may be customized

|**Commands** (Layer 4)
|Synchronized to project, versioned via git
|Project-specific workflows
|===

**Implication**: Skills act as "latest" adapters to standards, while agents can be version-controlled per project.
