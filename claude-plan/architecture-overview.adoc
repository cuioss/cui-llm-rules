= CUI LLM Rules: Plugin Architecture Overview
:toc: left
:toclevels: 3
:sectnums:

== Introduction

This document describes the architectural design of the cui-llm-rules Claude Code plugin, which provides centralized standards, skills, agents, and commands for CUI (Common User Interface) OSS projects.

== Executive Summary

The cui-llm-rules repository transforms from a documentation-only repository into a Claude Code plugin that provides a four-layer architecture:

* **Standards**: Authoritative technical requirements (existing AsciiDoc documentation)
* **Skills**: Knowledge layers that reference standards and provide methodologies
* **Agents**: Task executors that use skills and embedded essential rules
* **Commands**: User-invoked utilities for verification and management

All layers are distributed via a single plugin installation, eliminating manual synchronization.

== Four-Layer Architecture Model

=== Layer Overview

----
Layer 1: Standards (AsciiDoc) - Source of truth
Layer 2: Skills (SKILL.md) - Knowledge & methodology (references Layer 1)
Layer 3: Agents (agent.md) - Task executors (use Layer 2, embed essential rules from Layer 1)
Layer 4: Commands (command.md) - User utilities
----

=== Visual Architecture

[source]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: Standards (Source of Truth)                        â”‚
â”‚ Location: cui-llm-rules/standards/                          â”‚
â”‚ Format: AsciiDoc (.adoc)                                    â”‚
â”‚ Purpose: Define technical requirements                      â”‚
â”‚                                                              â”‚
â”‚ Examples:                                                    â”‚
â”‚ â€¢ java/java-code-standards.adoc                             â”‚
â”‚ â€¢ testing/core-standards.adoc                               â”‚
â”‚ â€¢ documentation/javadoc-standards.adoc                      â”‚
â”‚ â€¢ process/task-completion-standards.adoc                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚ Referenced by (dynamic reads)
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: Skills (Knowledge & Methodology)                   â”‚
â”‚ Location: cui-llm-rules/skills/                             â”‚
â”‚ Format: SKILL.md with YAML frontmatter                      â”‚
â”‚ Purpose: Provide Claude with context and methodology        â”‚
â”‚                                                              â”‚
â”‚ Examples:                                                    â”‚
â”‚ â€¢ cui-java-standards/SKILL.md                               â”‚
â”‚   - Reads standards/java/*.adoc dynamically                 â”‚
â”‚   - Provides quick reference, templates, examples           â”‚
â”‚   - allowed-tools: Read                                     â”‚
â”‚                                                              â”‚
â”‚ â€¢ cui-testing-methodology/SKILL.md                          â”‚
â”‚ â€¢ cui-documentation-standards/SKILL.md                      â”‚
â”‚ â€¢ cui-process-standards/SKILL.md                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚ Used by (skills referenced in prompts)
                            â”‚
                            â”‚ Embedded essential rules (synced via agents-doctor)
                            â”‚ from Layer 1
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: Agents (Task Executors)                            â”‚
â”‚ Location: cui-llm-rules/agents/                             â”‚
â”‚ Format: agent.md with YAML frontmatter                      â”‚
â”‚ Purpose: Autonomous task execution                          â”‚
â”‚                                                              â”‚
â”‚ Pattern: Essential Rules (embedded) + Skill References      â”‚
â”‚                                                              â”‚
â”‚ Examples:                                                    â”‚
â”‚ â€¢ project-builder.md                                        â”‚
â”‚   - System prompt: "Read cui-java-standards skill"          â”‚
â”‚   - Essential Rules: Embedded JavaDoc/testing requirements  â”‚
â”‚   - Tools: Read, Edit, Write, Bash                          â”‚
â”‚                                                              â”‚
â”‚ â€¢ code-reviewer.md                                          â”‚
â”‚ â€¢ adoc-review.md                                            â”‚
â”‚ â€¢ test-generator.md                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 4: Commands (User Utilities)                          â”‚
â”‚ Location: cui-llm-rules/commands/                           â”‚
â”‚ Format: Markdown                                            â”‚
â”‚ Purpose: User-invoked utilities and verification            â”‚
â”‚                                                              â”‚
â”‚ Examples:                                                    â”‚
â”‚ â€¢ agents-doctor.md - Verify agents, sync essential rules    â”‚
â”‚ â€¢ slash-doctor.md - Verify commands                         â”‚
â”‚ â€¢ setup-project-permissions.md                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â–²
           â”‚ All layers distributed via Plugin
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PLUGIN: cui-standards                                        â”‚
â”‚ Installation: /plugin install cui-standards@cui-llm-rules   â”‚
â”‚ Updates: /plugin marketplace update cui-llm-rules           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

== Key Architectural Decisions

=== Decision 1: Skills Reference Standards (Not Embed)

* **Rationale**: Standards are authoritative source, skills provide access layer
* **Implementation**: Skills use Read tool to dynamically fetch from `standards/`
* **Benefit**: No duplication between skills, always current

==== Skills Distribution Strategy

**IMPLEMENTATION STATUS**: âœ… Verified approach defined and tested (2025-10-22)

Skills must be distributed to make them available across different platforms. The verified and recommended approach is:

**Project Synchronization (REQUIRED for Cross-Platform Support)**

This approach synchronizes skills to project `.claude/skills/` directory (git-controlled), making them available on all platforms.

* **Status**: âœ… Verified and works on all platforms TODAY
* **Platforms**: Claude Code, Claude.ai web, CI/CD
* **Implementation**: Use `/synchronize --all --include-skills` command
* **Trade-off**: Requires explicit synchronization, must update when plugin changes
* **Benefit**: Works everywhere, no runtime dependencies, team consistency
* **Specification**: See xref:synchronize-command-spec.adoc[Synchronize Command Specification]

**This is the ONLY verified approach. Always use this method.**

**Future Research: Dynamic Repository Access** ðŸ”¬ THEORETICAL (NOT TESTED)

A theoretical alternative would access skills dynamically from repository URLs at runtime, avoiding synchronization. This approach:

* **Status**: ðŸ”¬ Unverified theoretical proposal - research deferred (see xref:research-topics.adoc#_1_skills_access_from_claudeai_web[Research Topics Â§ Skills Access])
* **Risk**: May not work on Claude.ai web or CI/CD platforms
* **Dependencies**: Would require network access and WebFetch capabilities
* **Current Recommendation**: Do NOT attempt this approach - use Project Synchronization instead

**Note**: This theoretical approach is documented for architectural completeness but is NOT recommended for use.

=== Appendix: Theoretical Dynamic Access Design (Research Only)

**IMPLEMENTATION STATUS**: ðŸ”¬ Theoretical proposal only - NOT for implementation

**WARNING**: This section documents a theoretical approach for future research. Do NOT implement this. Use Project Synchronization instead.

The following describes how dynamic skills access COULD theoretically work if research verification succeeds. This is included for:
* Architectural completeness
* Future research planning
* Understanding why Project Synchronization is necessary

**Do not use this design.** It remains unverified and is not recommended.

==== Theoretical Mechanism: Dynamic Skills Access

**THEORETICAL: When Claude Code is Running:**

1. **Plugin Installation Provides Skills**
   * Skills remain in plugin directory: `~/.claude/plugins/cui-standards/skills/`
   * Claude loads skill metadata (name, description) at startup
   * Full skill content loaded via Read tool when needed
   * Skills use relative paths (`./standards/...`) which resolve against plugin root

2. **Agent References in Synchronized .claude/ Files**
   * Agents synchronized to `.claude/agents/` contain prompts like: "Read cui-java-standards skill"
   * Claude resolves skill name to plugin installation path
   * Reads `~/.claude/plugins/cui-standards/skills/cui-java-standards/SKILL.md`
   * Skill then reads standards files via relative paths

**THEORETICAL: When Using Claude.ai Web or CI/CD:**

**WARNING**: This entire section is THEORETICAL and unverified. Do not rely on this mechanism.

1. **Agents Are Git-Controlled** âœ… (This part is verified - agents can be git-controlled)
   * Project has `.claude/agents/` with synchronized agents (committed to git)
   * Agents reference skills by name in their prompts

2. **Skills Must Be Accessible via Repository** âš ï¸ **UNVERIFIED - REQUIRES TESTING**
   * **Public Repository - PROPOSED**: Claude can access via GitHub API/web fetch
     - Repository URL: `https://github.com/cuioss/cui-llm-rules`
     - Skill path: `skills/cui-java-standards/SKILL.md`
     - Standards path: `standards/java/java-code-standards.adoc`

   * **Private/Offline Repository - MECHANISM UNKNOWN**: See xref:research-topics.adoc#_5_private_repository_access[Research Topics Â§ Private Repository Access]
     - **Possible approaches** (all unverified):
       * Clone repository to accessible location
       * Configure path in project `.claude/settings.json` (if this field exists)
       * Reference local clone path in agent prompts
       * Require repository to be public

3. **Resolution Flow**
   ```
   Agent prompt: "Read cui-java-standards skill from https://github.com/cuioss/cui-llm-rules"
   â†’ Claude fetches: https://github.com/cuioss/cui-llm-rules/skills/cui-java-standards/SKILL.md
   â†’ Skill references: ./standards/java/java-code-standards.adoc
   â†’ Claude fetches: https://github.com/cuioss/cui-llm-rules/standards/java/java-code-standards.adoc
   ```

==== Theoretical Requirements (ALL UNVERIFIED)

If this theoretical approach were ever implemented, these requirements would need validation:

* âš ï¸ Repository must be public OR agents must include explicit repository URLs
* âš ï¸ Skills would NOT be synchronized to `.claude/` (to avoid drift)
* âš ï¸ Standards files must be accessible via same mechanism as skills
* âš ï¸ Relative path resolution must work when Claude fetches from repository root
* âš ï¸ Network access must be available at runtime
* âš ï¸ Claude.ai web must support WebFetch or similar for GitHub content

**Verification Required**: See xref:research-topics.adoc#_1_skills_access_from_claudeai_web[Research Topics Â§ Skills Access from Claude.ai Web]

=== Implementation Guidance

**IMPLEMENTATION STATUS**: âœ… Verified and ready for use

**For All Users - Required Approach**:

* âœ… **Use Project Synchronization** (the only verified method)
* âœ… Synchronize skills to `.claude/skills/` via `/synchronize --all --include-skills`
* âœ… Commit `.claude/` to git for team distribution
* âœ… Update periodically when plugin version changes (use `/synchronize --check` to detect outdated components)

**Complete procedure**:
```bash
/plugin install cui-standards@cui-llm-rules  # (if using Claude Code)
/synchronize --all --include-skills           # REQUIRED for cross-platform
git add .claude/
git commit -m "sync: Add cui-standards components"
```

See xref:synchronize-command-spec.adoc[Synchronize Command Specification] for detailed instructions.

=== Implementation Decision Guide

Use this table to determine the correct approach for your scenario:

[cols="2,1,2"]
|===
|Your Scenario |Install Plugin? |Synchronize to .claude/? (includes skills)

|**Solo developer, Claude Code only**
|âœ… Yes
|âœ… **RECOMMENDED** (simpler, consistent with team workflow)

|**Team, all use Claude Code**
|âœ… Yes (all members)
|âœ… **REQUIRED** (for consistency)

|**Team, mixed Claude Code + Web**
|âœ… Yes (Code users)
|âœ… **REQUIRED**

|**Claude.ai web only (no CLI)**
|âŒ Not possible
|âœ… **REQUIRED** (only option)

|**CI/CD pipelines only**
|âŒ Not possible
|âœ… **REQUIRED** (only option)

|**Private repository for standards**
|âœ… Yes (if using Code)
|âœ… **REQUIRED**
|===

**Key Takeaways**:

* **Skills must always be synchronized** - Use `/synchronize --all --include-skills`
* **Agents and commands must be synchronized** for cross-platform support
* **Web/CI/CD users** = Synchronization is the only option (no plugin support)
* **Claude Code users** = Install plugin + synchronize for best experience
* **All scenarios** = Commit `.claude/` to git for version control and distribution

**Commands**:

```bash
# For mixed teams, web users, CI/CD, or private repos
/plugin install cui-standards@cui-llm-rules  # (if using Claude Code)
/synchronize --all --include-skills           # REQUIRED
git add .claude/
git commit -m "sync: Add cui-standards components"
git push

# For Claude Code users (any team size)
/plugin install cui-standards@cui-llm-rules   # Install plugin
/synchronize --all --include-skills            # RECOMMENDED (ensures consistency)
git add .claude/
git commit -m "sync: Add cui-standards components"
```

=== Decision 2: Agents Use Essential Rules Pattern (Custom Implementation)

Agents embed core requirements from standards for performance while maintaining skill references for complete information. This custom pattern provides fast, autonomous execution without I/O overhead while keeping access to complete standards when needed.

**Complete specification**: xref:component-specifications.adoc#essential-rules-pattern-custom-implementation[Component Specifications Â§ Essential Rules Pattern]

=== Decision 3: Plugin-Based Distribution

* **Rationale**: Native Claude Code mechanism, no manual copying
* **Implementation**: cui-llm-rules becomes installable plugin
* **Benefit**: Version control, team consistency, automatic updates

=== Decision 4: Project `.claude/` Priority Model

**Context-Dependent Role**: Project `.claude/` serves different purposes depending on user's platform:

**For Claude Code Users** (have plugin installed):

* `.claude/` files **OVERRIDE** plugin-provided components
* Plugin provides defaults, project customizes
* Use case: Project-specific variations of standard agents/skills

**For Claude.ai Web / CI/CD Users** (no plugin support):

* `.claude/` files are the **PRIMARY (only) mechanism**
* No plugin available, all components must be in `.claude/`
* Use case: Git-controlled distribution to non-CLI users

**Implementation**:

* Components in `.claude/skills/`, `.claude/agents/`, `.claude/commands/` take precedence over plugin
* Synchronized via `/synchronize` command from plugin installation
* Git-controlled for team distribution

**Benefit**: Single mechanism serves both use cases (customization + distribution)

== Progressive Disclosure Model

=== Skills Loading Pattern

Skills utilize progressive disclosure as validated by research:

. **Startup Phase**: Name + description loaded (30-50 tokens)
. **Context Matching**: Claude determines relevance based on task
. **Dynamic Fetch**: Read tool loads `SKILL.md` and referenced files only when needed

This pattern ensures:

* Low memory footprint at startup
* Current data always (read from source)
* Efficient resource usage

=== Conflict Resolution Hierarchy

Project-level files take precedence over plugin-provided files:

----
Priority: Project .claude/ > User ~/.claude/ > Plugin-provided
----

For nested CLAUDE.md files, the most specific (deepest nested) takes priority.

== Installation and Updates

* **Installation**: xref:plugin-structure.adoc#installation[Plugin Structure Â§ Installation]
* **Version Management**: xref:plugin-structure.adoc#version-management[Plugin Structure Â§ Version Management]
* **Update**: `/plugin marketplace update cui-llm-rules` (no version pinning available)
