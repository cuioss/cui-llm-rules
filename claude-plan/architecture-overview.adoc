= CUI LLM Rules: Plugin Architecture Overview
:toc: left
:toclevels: 3
:sectnums:

== Introduction

This document describes the architectural design of the cui-llm-rules Claude Code plugin, which provides centralized standards, skills, agents, and commands for CUI (Common User Interface) OSS projects.

== Executive Summary

The cui-llm-rules repository transforms from a documentation-only repository into a Claude Code plugin that provides a four-layer architecture:

* **Standards**: Authoritative technical requirements (existing AsciiDoc documentation)
* **Skills**: Knowledge layers that reference standards and provide methodologies
* **Agents**: Task executors that use skills and embedded essential rules
* **Commands**: User-invoked utilities for verification and management

All layers are distributed via a single plugin installation, eliminating manual synchronization.

== Four-Layer Architecture Model

=== Layer Overview

----
Layer 1: Standards (AsciiDoc) - Source of truth
Layer 2: Skills (SKILL.md) - Knowledge & methodology (references Layer 1)
Layer 3: Agents (agent.md) - Task executors (use Layer 2, embed essential rules from Layer 1)
Layer 4: Commands (command.md) - User utilities
----

=== Visual Architecture

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ LAYER 1: Standards (Source of Truth)                        │
│ Location: cui-llm-rules/standards/                          │
│ Format: AsciiDoc (.adoc)                                    │
│ Purpose: Define technical requirements                      │
│                                                              │
│ Examples:                                                    │
│ • java/java-code-standards.adoc                             │
│ • testing/core-standards.adoc                               │
│ • documentation/javadoc-standards.adoc                      │
│ • process/task-completion-standards.adoc                    │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ Referenced by (dynamic reads)
                            │
┌─────────────────────────────────────────────────────────────┐
│ LAYER 2: Skills (Knowledge & Methodology)                   │
│ Location: cui-llm-rules/skills/                             │
│ Format: SKILL.md with YAML frontmatter                      │
│ Purpose: Provide Claude with context and methodology        │
│                                                              │
│ Examples:                                                    │
│ • cui-java-standards/SKILL.md                               │
│   - Reads standards/java/*.adoc dynamically                 │
│   - Provides quick reference, templates, examples           │
│   - allowed-tools: Read                                     │
│                                                              │
│ • cui-testing-methodology/SKILL.md                          │
│ • cui-documentation-standards/SKILL.md                      │
│ • cui-process-standards/SKILL.md                            │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ Used by (skills referenced in prompts)
                            │
                            │ Embedded essential rules (synced via agents-doctor)
                            │ from Layer 1
                            │
┌─────────────────────────────────────────────────────────────┐
│ LAYER 3: Agents (Task Executors)                            │
│ Location: cui-llm-rules/agents/                             │
│ Format: agent.md with YAML frontmatter                      │
│ Purpose: Autonomous task execution                          │
│                                                              │
│ Pattern: Essential Rules (embedded) + Skill References      │
│                                                              │
│ Examples:                                                    │
│ • project-builder.md                                        │
│   - System prompt: "Read cui-java-standards skill"          │
│   - Essential Rules: Embedded JavaDoc/testing requirements  │
│   - Tools: Read, Edit, Write, Bash                          │
│                                                              │
│ • code-reviewer.md                                          │
│ • adoc-review.md                                            │
│ • test-generator.md                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ LAYER 4: Commands (User Utilities)                          │
│ Location: cui-llm-rules/commands/                           │
│ Format: Markdown                                            │
│ Purpose: User-invoked utilities and verification            │
│                                                              │
│ Examples:                                                    │
│ • agents-doctor.md - Verify agents, sync essential rules    │
│ • slash-doctor.md - Verify commands                         │
│ • setup-project-permissions.md                              │
└─────────────────────────────────────────────────────────────┘

           ▲
           │ All layers distributed via Plugin
           │
┌──────────┴──────────────────────────────────────────────────┐
│ PLUGIN: cui-standards                                        │
│ Installation: /plugin install cui-standards@cui-llm-rules   │
│ Updates: /plugin marketplace update cui-llm-rules           │
└─────────────────────────────────────────────────────────────┘
----

== Key Architectural Decisions

=== Decision 1: Skills Reference Standards (Not Embed)

* **Rationale**: Standards are authoritative source, skills provide access layer
* **Implementation**: Skills use Read tool to dynamically fetch from `standards/`
* **Benefit**: No duplication between skills, always current

==== Skills Distribution Strategy

**IMPLEMENTATION STATUS**: ✅ Verified approach defined and tested (2025-10-22)

Skills must be distributed to make them available across different platforms. The verified and recommended approach is:

**Project Synchronization (REQUIRED for Cross-Platform Support)**

This approach synchronizes skills to project `.claude/skills/` directory (git-controlled), making them available on all platforms.

* **Status**: ✅ Verified and works on all platforms TODAY
* **Platforms**: Claude Code, Claude.ai web, CI/CD
* **Implementation**: Use `/synchronize --all --include-skills` command
* **Trade-off**: Requires explicit synchronization, must update when plugin changes
* **Benefit**: Works everywhere, no runtime dependencies, team consistency
* **Specification**: See xref:synchronize-command-spec.adoc[Synchronize Command Specification]

**This is the ONLY possible approach.** Skills must be filesystem-based per Claude Code architecture.

**Why Dynamic Repository Access is Impossible** ❌

Research confirmed that loading skills from repository URLs at runtime is architecturally impossible:

* ❌ **Skills must be local files** - Claude Code's progressive disclosure requires filesystem access
* ❌ **No remote loading capability** - WebFetch tool cannot load skills from URLs
* ❌ **Claude.ai web requires ZIP upload** - No GitHub repository access for skills
* ❌ **Architecture limitation** - Skills discovery depends on local directory scanning

**Evidence**: Official Anthropic documentation (see xref:research-topics.adoc#_1_skills_access_from_claudeai_web[Research Topics § Skills Access])

=== Implementation Guidance

**IMPLEMENTATION STATUS**: ✅ Verified and ready for use

**For All Users - REQUIRED Approach**:

* ✅ **MUST use Project Synchronization** (the only architecturally possible method)
* ✅ **MUST synchronize skills** to `.claude/skills/` via `/synchronize --all --include-skills`
* ✅ **MUST commit** `.claude/` to git for team distribution
* ✅ **MUST update** periodically when plugin version changes (use `/synchronize --check` to detect outdated components)

**Why synchronization is required**: Claude Code's skills architecture requires local filesystem access. Dynamic loading from URLs is impossible.

**Complete procedure**:
```bash
/plugin install cui-standards@cui-llm-rules  # (if using Claude Code)
/synchronize --all --include-skills           # REQUIRED for cross-platform
git add .claude/
git commit -m "sync: Add cui-standards components"
```

See xref:synchronize-command-spec.adoc[Synchronize Command Specification] for detailed instructions.

=== Implementation Decision Guide

Use this table to determine the correct approach for your scenario:

[cols="2,1,2"]
|===
|Your Scenario |Install Plugin? |Synchronize to .claude/? (includes skills)

|**Solo developer, Claude Code only**
|✅ Yes
|✅ **RECOMMENDED** (simpler, consistent with team workflow)

|**Team, all use Claude Code**
|✅ Yes (all members)
|✅ **REQUIRED** (for consistency)

|**Team, mixed Claude Code + Web**
|✅ Yes (Code users)
|✅ **REQUIRED**

|**Claude.ai web only (no CLI)**
|❌ Not possible
|✅ **REQUIRED** (only option)

|**CI/CD pipelines only**
|❌ Not possible
|✅ **REQUIRED** (only option)

|**Private repository for standards**
|✅ Yes (if using Code)
|✅ **REQUIRED**
|===

**Key Takeaways**:

* **Skills must always be synchronized** - Use `/synchronize --all --include-skills`
* **Agents and commands must be synchronized** for cross-platform support
* **Web/CI/CD users** = Synchronization is the only option (no plugin support)
* **Claude Code users** = Install plugin + synchronize for best experience
* **All scenarios** = Commit `.claude/` to git for version control and distribution

**Commands**:

```bash
# For mixed teams, web users, CI/CD, or private repos
/plugin install cui-standards@cui-llm-rules  # (if using Claude Code)
/synchronize --all --include-skills           # REQUIRED
git add .claude/
git commit -m "sync: Add cui-standards components"
git push

# For Claude Code users (any team size)
/plugin install cui-standards@cui-llm-rules   # Install plugin
/synchronize --all --include-skills            # RECOMMENDED (ensures consistency)
git add .claude/
git commit -m "sync: Add cui-standards components"
```

=== Decision 2: Agents Use Essential Rules Pattern (Custom Implementation)

Agents embed core requirements from standards for performance while maintaining skill references for complete information. This custom pattern provides fast, autonomous execution without I/O overhead while keeping access to complete standards when needed.

**Complete specification**: xref:component-specifications.adoc#essential-rules-pattern-custom-implementation[Component Specifications § Essential Rules Pattern]

=== Decision 3: Plugin-Based Distribution

* **Rationale**: Native Claude Code mechanism, no manual copying
* **Implementation**: cui-llm-rules becomes installable plugin
* **Benefit**: Version control, team consistency, automatic updates

=== Decision 4: Project `.claude/` Priority Model

**Context-Dependent Role**: Project `.claude/` serves different purposes depending on user's platform:

**For Claude Code Users** (have plugin installed):

* `.claude/` files **OVERRIDE** plugin-provided components
* Plugin provides defaults, project customizes
* Use case: Project-specific variations of standard agents/skills

**For Claude.ai Web / CI/CD Users** (no plugin support):

* `.claude/` files are the **PRIMARY (only) mechanism**
* No plugin available, all components must be in `.claude/`
* Use case: Git-controlled distribution to non-CLI users

**Implementation**:

* Components in `.claude/skills/`, `.claude/agents/`, `.claude/commands/` take precedence over plugin
* Synchronized via `/synchronize` command from plugin installation
* Git-controlled for team distribution

**Benefit**: Single mechanism serves both use cases (customization + distribution)

== Progressive Disclosure Model

=== Skills Loading Pattern

Skills utilize progressive disclosure as validated by research:

. **Startup Phase**: Name + description loaded (30-50 tokens)
. **Context Matching**: Claude determines relevance based on task
. **Dynamic Fetch**: Read tool loads `SKILL.md` and referenced files only when needed

This pattern ensures:

* Low memory footprint at startup
* Current data always (read from source)
* Efficient resource usage

=== Conflict Resolution Hierarchy

Project-level files take precedence over plugin-provided files:

----
Priority: Project .claude/ > User ~/.claude/ > Plugin-provided
----

For nested CLAUDE.md files, the most specific (deepest nested) takes priority.

== Installation and Updates

* **Installation**: xref:plugin-structure.adoc#installation[Plugin Structure § Installation]
* **Version Management**: xref:plugin-structure.adoc#version-management[Plugin Structure § Version Management]
* **Update**: `/plugin marketplace update cui-llm-rules` (no version pinning available)
