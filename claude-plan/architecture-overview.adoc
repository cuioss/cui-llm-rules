= CUI LLM Rules: Plugin Architecture Overview
:toc: left
:toc-title: Table of Contents
:toclevels: 3
:sectnums:
:source-highlighter: highlight.js

== Introduction

This document describes the architectural design of the cui-llm-rules Claude Code plugin, which provides centralized standards, skills, agents, and commands for CUI (Common User Interface) OSS projects.

== Executive Summary

The cui-llm-rules repository provides a Claude Code plugin with a three-layer architecture:

* **Skills**: Self-contained bundles containing standards (AsciiDoc), methodology, and workflow logic
* **Agents**: Task executors that use skills and embed essential rules from skill standards
* **Commands**: User-invoked utilities for verification and management

All layers are distributed via a single plugin installation, eliminating manual synchronization.

== Three-Layer Architecture Model

=== Layer Overview

----
Layer 1: Skills (SKILL.md + bundled standards) - Knowledge, methodology, and standards
Layer 2: Agents (agent.md) - Task executors (use Layer 1, embed essential rules from Layer 1)
Layer 3: Commands (command.md) - User utilities
----

**Key Change**: Standards are now bundled within skills rather than maintained separately. Each skill is a self-contained package containing its SKILL.md workflow file and all related standards files in a `standards/` subdirectory.

=== Visual Architecture

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ LAYER 1: Skills (Self-Contained Bundles)                    │
│ Location: cui-llm-rules/skills/                             │
│ Purpose: Knowledge, methodology, and standards              │
│                                                              │
│ Structure: Each skill is a complete package                 │
│                                                              │
│ Example: cui-java-development/                              │
│   ├── SKILL.md                                              │
│   │   - YAML frontmatter (name, description, tools)         │
│   │   - Workflow with explicit Read instructions           │
│   │   - Progressive loading logic                           │
│   │   - Templates and examples                              │
│   │                                                          │
│   └── standards/                                            │
│       ├── java-core-standards.adoc (always)                 │
│       ├── java-lombok-standards.adoc (always)               │
│       ├── java-jspecify-standards.adoc (always)             │
│       ├── logging-standards.adoc (always)                   │
│       ├── javadoc-standards.adoc (conditional)              │
│       ├── testing-junit-standards.adoc (conditional)        │
│       └── cdi-*.adoc (conditional)                          │
│                                                              │
│ Other Skills:                                                │
│ • cui-javadoc/ (JavaDoc standards)                          │
│ • cui-java-cdi/ (CDI/Quarkus standards)                     │
│ • cui-java-unit-testing/ (JUnit testing)                    │
│ • cui-frontend-development/ (JS, CSS, web components)       │
│ • cui-documentation/ (general docs standards)               │
│ • cui-project-setup/ (project initialization)               │
│ • cui-requirements/ (requirements & specs)                  │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ Used by (skills referenced in agent prompts)
                            │
                            │ Embedded essential rules (synced via agents-doctor)
                            │ extracted from skill standards
                            │
┌─────────────────────────────────────────────────────────────┐
│ LAYER 2: Agents (Task Executors)                            │
│ Location: cui-llm-rules/agents/                             │
│ Format: agent.md with YAML frontmatter                      │
│ Purpose: Autonomous task execution                          │
│                                                              │
│ Pattern: Essential Rules (embedded) + Skill Invocation      │
│                                                              │
│ Example: project-builder.md                                 │
│   - Invokes: cui-java-development skill                     │
│   - Essential Rules: Embedded core requirements from        │
│     cui-java-development/standards/*.adoc                   │
│   - Tools: Read, Edit, Write, Bash                          │
│   - Progressive: Skill loads full standards as needed       │
│                                                              │
│ Other Agents:                                                │
│ • code-reviewer.md (uses cui-java-core + cui-javadoc)       │
│ • adoc-review.md (uses cui-documentation skill)             │
│ • test-generator.md (uses cui-java-unit-testing skill)      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ LAYER 3: Commands (User Utilities)                          │
│ Location: cui-llm-rules/commands/                           │
│ Format: Markdown                                            │
│ Purpose: User-invoked utilities and verification            │
│                                                              │
│ Examples:                                                    │
│ • agents-doctor.md                                          │
│   - Verifies agents follow best practices                   │
│   - Syncs essential rules from skill standards              │
│   - Validates tool coverage                                 │
│                                                              │
│ • slash-doctor.md - Verify commands                         │
│ • setup-project-permissions.md - Permission management      │
└─────────────────────────────────────────────────────────────┘

           ▲
           │ All layers distributed via Plugin
           │
┌──────────┴──────────────────────────────────────────────────┐
│ PLUGIN: cui-standards                                        │
│ Installation: /plugin install cui-standards@cui-llm-rules   │
│ Updates: /plugin marketplace update cui-llm-rules           │
│                                                              │
│ Progressive Disclosure:                                      │
│ 1. Skill description loaded (30-50 tokens)                  │
│ 2. On invocation: SKILL.md loaded (~400 lines)              │
│ 3. Workflow executes: Reads relevant standards files        │
│ 4. Conditional loading: Only needed standards loaded        │
└─────────────────────────────────────────────────────────────┘
----

== Key Architectural Decisions

=== Decision 1: Bundled Skills with Explicit Read Instructions

**Pattern**: Skills are self-contained bundles with standards in subdirectories, using explicit Read workflow instructions

**Architecture**:

```
skills/cui-java-development/
├── SKILL.md (workflow + logic)
└── standards/
    ├── java-core-standards.adoc
    ├── java-lombok-standards.adoc
    ├── javadoc-standards.adoc
    └── ... (all related standards)
```

**Rationale**:

* **Self-Contained**: Each skill is a complete, distributable package
* **Reliable Loading**: Explicit Read instructions proven reliable (agents-doctor pattern)
* **Progressive Disclosure**: Standards loaded conditionally based on context
* **Clear Ownership**: Each skill owns and maintains its standards
* **Activity-Based**: Skills map to developer workflows, not technology subdivisions
* **No External Dependencies**: Skills don't rely on separate standards repository

**Implementation**:

Skills contain workflow steps that explicitly instruct Claude to execute Read tool on bundled standards:

[source,markdown]
----
### Step 1: Load Applicable Standards

**CRITICAL**: Load current standards to use as enforcement criteria.

1. **Always load foundational standards**:
   ```
   Read: standards/java-core-standards.adoc
   Read: standards/java-lombok-standards.adoc
   Read: standards/java-jspecify-standards.adoc
   Read: standards/logging-standards.adoc
   ```
   These are fundamental to all CUI Java development.

2. **Conditional loading based on code context**:
   - If documenting:
     ```
     Read: standards/javadoc-standards.adoc
     ```
   - If testing:
     ```
     Read: standards/testing-junit-standards.adoc
     ```
   - If CDI/Quarkus:
     ```
     Read: standards/cdi-standards.adoc
     ```

3. **Extract key requirements from all loaded standards**

4. **Store in working memory** for use during task execution
----

**Cross-Cutting Standards**:

When standards are used by multiple skills (e.g., JavaDoc used by both Java and Documentation skills):

* **Preferred**: Use symlinks (git symlinks with `core.symlinks true`)
* **Alternative**: Direct cross-skill references (`../cui-java-development/standards/...`)
* **Natural**: Let Claude compose multiple skills automatically for complex workflows

See xref:skill-distribution.adoc#cross-cutting-standards[Skill Distribution § Cross-Cutting Standards] for detailed approaches.

**Benefits**:

* **Self-contained distribution** - each skill is a complete package
* **Reliable loading** - explicit Read tool invocation (not passive reference)
* **Progressive disclosure** - only loads relevant standards based on context
* **Token efficient** - skill description loads first (30-50 tokens), then SKILL.md (~400 lines), then only needed standards
* **Activity-based granularity** - 4-6 skills vs 20+ micro-skills
* **Clear ownership** - each skill maintains its standards
* **Proven pattern** - successfully used in agents-doctor command

**Evidence**:

* Pattern validated through agents-doctor implementation
* Web research on Claude Code's progressive disclosure architecture
* Skill bundling pattern documented in official Claude Code skills documentation

**Detailed Specification**: See xref:skill-distribution.adoc[Skill Distribution and Standards Clustering]

==== Component Distribution Strategy

**Plugin Distribution**

All components (skills, agents, commands) are distributed via plugin marketplace installation.

* **Target Platform**: Claude Code CLI only
* **Components Distributed**: Skills, Agents, Commands (all three types)
* **Installation**: Single command: `/plugin install cui-standards@cui-llm-rules`
* **Benefits**:

  - Automatic component discovery
  - Built-in version management
  - No manual file management

* **Evidence**: See xref:research-topics.adoc[Research Topics] for verification details

=== Installation Instructions

Plugin installation is simple and handles all component registration automatically:

```bash
/plugin marketplace add cuioss/cui-llm-rules
/plugin install cui-standards@cui-llm-rules
```

All components (skills, agents, commands) are immediately available after installation.

For complete installation details including verification steps, update procedures, version management, and troubleshooting, see xref:plugin-structure.adoc#installation[Plugin Structure § Installation].

=== Target Users

**Supported Users**: Claude Code CLI users only

**Platform Scope**:

* ✅ Claude Code CLI (terminal)
* ✅ Claude Code in VS Code
* ❌ Claude.ai web interface (not supported - agents/commands don't exist on web)
* ❌ CI/CD pipelines (plugin installation requires interactive mode)

**Rationale**: Plugin distribution provides native integration with Claude Code's component discovery and version management systems.

=== Key Architectural Decisions

==== Decision 1: Plugin-Only Distribution

* **Rationale**: Native Claude Code mechanism with established marketplace ecosystem
* **Implementation**: cui-llm-rules distributed as plugin via marketplace
* **Benefits**:
  - Single command installation
  - Automatic component discovery
  - Built-in version management
  - No manual file management

==== Decision 2: Agents Use Essential Rules Pattern

Agents embed core requirements from skill standards for performance while invoking skills for complete information. This provides fast, autonomous execution without I/O overhead while keeping access to complete standards when needed.

**Pattern**:

```markdown
# agent-name.md

## Essential Rules

### Java Standards
Source: ~/plugins/cui-llm-rules/skills/cui-java-development/standards/java-core-standards.adoc#key-patterns
Last Synced: 2025-10-23

- All constants must use DSL-style naming (UPPER_SNAKE_CASE)
- All public methods require JavaDoc
- Use @NonNull/@Nullable annotations
...

## Workflow

When developing Java code, invoke cui-java-development skill for complete standards.
```

**Rationale**:

* **Performance**: Agents have critical requirements immediately available (no I/O delay)
* **Completeness**: Agents can invoke skills for full standards when needed
* **Maintenance**: `agents-doctor` verifies embedded rules match skill standards source
* **Source of Truth**: Skill standards remain authoritative; agents embed copies

**Synchronization**:

Essential rules in agents reference skill standards as source:

```
Source: ~/plugins/cui-llm-rules/skills/cui-java-development/standards/java-core-standards.adoc#section
```

`agents-doctor` command verifies and syncs:

* Compares embedded rules with skill standards source
* Reports out-of-date rules
* Offers to update from source
* Tracks last sync date

**Complete specification**: xref:component-specifications.adoc#essential-rules-pattern-manual-maintenance-required[Component Specifications § Essential Rules Pattern]

==== Decision 3: Global Plugin Scope

* **Installation Location**: `~/.claude/plugins/marketplaces/cui-llm-rules/`
* **Availability**: Global across all projects for user
* **Customization**: Users can override specific components via project-level `.claude/` directories if needed

== Progressive Disclosure Model

=== Skills Loading Pattern

Skills utilize progressive disclosure as validated by research:

. **Startup Phase**: Name + description loaded (30-50 tokens)
. **Context Matching**: Claude determines relevance based on task
. **Skill Invocation**: Claude loads complete `SKILL.md` file
. **Workflow Execution**: Skill workflow explicitly instructs Claude to Read standards files
. **Standards Loading**: Claude executes Read tool commands from skill workflow

This pattern ensures:

* Low memory footprint at startup (skill description only)
* Current data always (reads from standards source at execution time)
* Efficient resource usage (only loads standards when skill is invoked)
* Reliable loading (explicit Read instructions, not passive references)
* Controlled context (skill determines which standards files to load)

=== Conflict Resolution Hierarchy

Project-level files take precedence over plugin-provided files:

----
Priority: Project .claude/ > User ~/.claude/ > Plugin-provided
----

For nested CLAUDE.md files, the most specific (deepest nested) takes priority.

== Installation and Updates

* **Installation**: xref:plugin-structure.adoc#installation[Plugin Structure § Installation]
* **Version Management**: xref:plugin-structure.adoc#version-management[Plugin Structure § Version Management]
* **Update**: `/plugin marketplace update cui-llm-rules` (no version pinning available)
