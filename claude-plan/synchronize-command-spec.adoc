= Synchronize Command Specification
:toc: left
:toclevels: 3
:sectnums:

== Overview

The `/synchronize` command copies selected agents and commands from the plugin installation to the project's `.claude/` directory, making them available in git-controlled projects for all platforms (Claude Code, Claude.ai web, CI/CD).

== Purpose

**Problem**: Claude.ai web interface and CI/CD pipelines cannot install plugins.

**Solution**: Synchronize selected components to project's `.claude/` directory, which is git-controlled and available to all users/platforms.

== Architecture Integration

=== Component Distribution Model

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ PLUGIN (Claude Code only)                                   │
│ Location: ~/.claude/plugins/cui-standards/                  │
│ Purpose: Source for synchronization                         │
│                                                              │
│ ├── agents/           # Available for synchronization       │
│ └── commands/         # Available for synchronization       │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ /synchronize command
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ PROJECT .claude/ (Git-controlled)                           │
│ Location: /path/to/project/.claude/                         │
│ Purpose: Project-specific agents/commands for all platforms │
│                                                              │
│ ├── agents/           # Synchronized copies                 │
│ │   ├── project-builder.md                                  │
│ │   └── adoc-review.md                                      │
│ └── commands/         # Synchronized copies                 │
│     └── agents-doctor.md                                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Runtime skill resolution
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ REPOSITORY (All platforms)                                  │
│ Location: https://github.com/cuioss/cui-llm-rules           │
│ Purpose: Skills and standards (dynamically accessed)        │
│                                                              │
│ ├── skills/           # Read dynamically by agents          │
│ │   └── cui-java-standards/SKILL.md                         │
│ └── standards/        # Referenced by skills                │
│     └── java/java-code-standards.adoc                       │
└─────────────────────────────────────────────────────────────┘
----

=== Platform Support

[cols="1,1,2"]
|===
|Platform |Plugin Install |Synchronized .claude/ Access

|**Claude Code (CLI/IDE)**
|✅ Yes
|✅ Yes (overrides plugin)

|**Claude.ai Web**
|❌ No
|✅ Yes (only way to access)

|**GitHub Actions**
|❌ No
|✅ Yes (only way to access)

|**CI/CD Pipelines**
|❌ No
|✅ Yes (only way to access)
|===

== Command Specification

=== Command Definition

**File**: `commands/synchronize.md`

**YAML Frontmatter**:
[source,yaml]
----
---
description: Synchronize selected agents and commands from plugin to project .claude/ directory for git-controlled distribution
argument-hint: "[agent-name...] [--all] [--commands] [--agents]"
---
----

=== Syntax

[source,bash]
----
# Interactive mode (default - no arguments)
/synchronize

# Synchronize specific agents by name
/synchronize project-builder adoc-review

# Synchronize specific commands by name
/synchronize --commands agents-doctor slash-doctor

# Synchronize all agents
/synchronize --all --agents

# Synchronize all commands
/synchronize --all --commands

# Synchronize everything
/synchronize --all
----

=== Parameters

* **No arguments**: Interactive mode - displays numbered lists for selection
* **agent-name...**: Space-separated list of agent/command names to synchronize
* **--all**: Synchronize all available components
* **--agents**: Target agents only (default: both agents and commands)
* **--commands**: Target commands only
* **--force**: Overwrite existing files without confirmation

=== Interactive Mode

When invoked without arguments, `/synchronize` enters interactive mode:

[source]
----
$ /synchronize

Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):

Available agents:
  1. project-builder         - Build and verify project with quality checks
  2. code-reviewer          - Code review with standards compliance
  3. adoc-review            - AsciiDoc documentation review
  4. commit-current-changes - Git commit with standards
  5. pr-handle-gemini       - Handle Gemini PR comments
  6. pr-handle-sonar        - Handle Sonar issues
  7. research-best-practices - Web research agent

Selection [1-7, all, skip]: 1 3

✓ Selected: project-builder, adoc-review

Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):

Available commands:
  1. agents-doctor              - Verify and fix agents
  2. slash-doctor               - Verify commands
  3. skills-doctor              - Verify skills
  4. agents-create              - Create new agent
  5. slash-create               - Create new command
  6. skills-create              - Create new skill
  7. setup-project-permissions  - Setup project permissions
  8. docs-technical-adoc-review - Technical documentation review
  9. handle-pull-request        - PR handling workflow
 10. verify-plantuml-diagrams   - Verify PlantUML diagrams
 11. verify-project             - Full project verification

Selection [1-11, all, skip]: 1 7

✓ Selected: agents-doctor, setup-project-permissions

Synchronizing 4 components to .claude/...

✓ Synchronized: .claude/agents/project-builder.md
✓ Synchronized: .claude/agents/adoc-review.md
✓ Synchronized: .claude/commands/agents-doctor.md
✓ Synchronized: .claude/commands/setup-project-permissions.md

Next steps:
  git add .claude/
  git commit -m "sync: Add selected agents and commands"

Note: Skills are accessed dynamically from repository (not synchronized)
----

== Workflow

=== 1. Discovery Phase

[source]
----
1. Detect plugin installation location
   - Check ~/.claude/plugins/cui-standards/
   - Or use plugin API to get installation path

2. Scan available components
   - List all agents from plugin/agents/
   - List all commands from plugin/commands/

3. Validate target names
   - Verify requested components exist
   - Report missing components
----

=== 2. Synchronization Phase

[source]
----
1. Ensure project .claude/ directories exist
   - Create .claude/agents/ if needed
   - Create .claude/commands/ if needed

2. Copy requested components
   - Read from plugin location
   - Write to .claude/agents/ or .claude/commands/
   - Preserve file permissions

3. Update metadata
   - Add "Synchronized from: cui-standards plugin" header
   - Add "Synchronized date: YYYY-MM-DD" timestamp
   - Preserve original content
----

=== 3. Verification Phase

[source]
----
1. Verify copied files
   - Check file exists in .claude/
   - Validate YAML frontmatter
   - Verify skill references are valid

2. Report results
   - List synchronized components
   - Show file locations
   - Warn about skill references (must access repo dynamically)
----

== Synchronized File Format

=== Agent File Header

When synchronized, agents get a metadata header:

[source,markdown]
----
<!--
Synchronized from: cui-standards plugin
Synchronized date: 2025-10-22
Source: agents/project-builder.md

This is a project-local copy. To update, run: /synchronize project-builder

Skills referenced by this agent are accessed dynamically from repository:
https://github.com/cuioss/cui-llm-rules
-->

---
name: project-builder
description: Build and verify project...
tools: Read, Edit, Write, Bash
---

[Original agent content follows...]
----

=== Skill References Preserved

Synchronized agents maintain skill references:

[source,markdown]
----
## STANDARDS COMPLIANCE

**Before fixing code, READ these skills for current standards:**
- `cui-java-standards` skill - Java coding, Javadoc, null-safety
- `cui-testing-methodology` skill - Test coverage requirements

The Essential Rules above are core requirements. For complete standards,
consult the skills from repository.
----

**Note**: Skills are accessed dynamically from repository, NOT from plugin.

== Git Integration

=== .gitignore Configuration

**DO NOT ignore** `.claude/` directory:

[source,gitignore]
----
# .gitignore

# DO NOT ignore .claude/ - it contains synchronized agents/commands
# .claude/

# Only ignore local settings (if any)
.claude/settings.local.json
----

=== Commit Strategy

[source,bash]
----
# After synchronization
git add .claude/agents/
git add .claude/commands/

git commit -m "sync: Add project-builder and adoc-review agents

Synchronized from cui-standards plugin for cross-platform compatibility.
These agents reference skills dynamically from cui-llm-rules repository.

Agents:
- project-builder: Build verification with quality checks
- adoc-review: Documentation review and validation"
----

=== Team Collaboration

**Workflow**:

1. **Developer A** (has Claude Code):
   ```bash
   # Install plugin
   /plugin install cui-standards@cui-llm-rules

   # Synchronize to project
   cd ~/project
   /synchronize project-builder adoc-review

   # Commit to git
   git add .claude/
   git commit -m "sync: Add agents for project"
   git push
   ```

2. **Developer B** (uses Claude.ai web):
   ```bash
   # Pull project
   git pull

   # .claude/ agents are now available
   # Uses them directly in Claude.ai web interface
   # Skills resolved from repository dynamically
   ```

3. **CI/CD Pipeline**:
   ```yaml
   # GitHub Action workflow
   - uses: actions/checkout@v4
   # .claude/ agents available in workspace
   # Skills accessed from repository
   ```

== Update Strategy

=== Updating Synchronized Components

When plugin updates:

[source,bash]
----
# Update plugin
/plugin marketplace update cui-llm-rules

# Re-synchronize to get updates
/synchronize project-builder --force

# Review changes
git diff .claude/agents/project-builder.md

# Commit if acceptable
git add .claude/agents/
git commit -m "sync: Update project-builder to latest version"
----

=== Selective Updates

[source,bash]
----
# Check which components need updates
/synchronize --check

# Output:
# ✓ project-builder.md - up to date
# ⚠ adoc-review.md - newer version available (2025-10-22 vs 2025-10-15)
# ⚠ agents-doctor.md - newer version available

# Update only specific components
/synchronize adoc-review agents-doctor --force
----

== Skills Synchronization

The `/synchronize` command can synchronize skills to `.claude/skills/` for cross-platform availability.

**Recommendation**: Synchronize skills along with agents and commands for reliable cross-platform operation.

[source,bash]
----
# Synchronize skills to project (recommended)
/synchronize --all --include-skills

# This copies:
# - Agents → .claude/agents/
# - Commands → .claude/commands/
# - Skills → .claude/skills/
----

**Distribution Strategies**: See xref:architecture-overview.adoc#skills-distribution-strategies[Architecture Overview § Skills Distribution Strategies] for complete details on two alternative approaches:

* **Strategy 1**: Skills Synchronization (Verified - works on all platforms)
* **Strategy 2**: Dynamic Repository Access (Proposed - requires verification)

**Mitigation for drift**:

* Synchronize regularly when plugin updates (weekly or on-demand)
* Document which plugin version was synchronized
* Use `/agents-doctor` to check for out-of-date skills

== Implementation Algorithm

High-level implementation approach:

. **Discovery Phase**
   * Locate plugin installation (`~/.claude/plugins/cui-standards/`)
   * Scan available agents and commands
   * Validate requested component names

. **Selection Phase**
   * **Interactive mode** (no arguments): Display numbered menus for agents and commands
   * **Command-line mode**: Parse arguments for specific components or `--all`
   * Extract descriptions from YAML frontmatter for display

. **Synchronization Phase**
   * Create `.claude/agents/` and `.claude/commands/` directories if needed
   * Copy selected components from plugin to project
   * Add synchronization metadata header (source, date, update command)
   * Preserve YAML frontmatter and content

. **Verification Phase**
   * Verify copied files exist and are valid
   * Report results with file locations
   * Display git commit instructions
   * Note about skills access mechanism

**Key Functions**:

* `discover_components(path)`: List agents/commands from plugin directory
* `interactive_selection()`: Display numbered menus, parse user input
* `copy_component(source, dest)`: Copy file with metadata header
* `validate_component(path)`: Check YAML frontmatter validity

== Error Handling

=== Plugin Not Installed

[source]
----
Error: cui-standards plugin not installed

Install plugin first:
  /plugin install cui-standards@cui-llm-rules

Or specify custom source path:
  /synchronize --source ~/custom-path project-builder
----

=== Component Not Found

[source]
----
Error: Component 'invalid-agent' not found

Available agents:
  - project-builder
  - adoc-review
  - commit-current-changes
  - code-reviewer

Available commands:
  - agents-doctor
  - slash-doctor
  - skills-doctor
----

=== Destination Exists

[source]
----
Warning: .claude/agents/project-builder.md already exists

Options:
  1. Skip (keep existing)
  2. Overwrite (use --force)
  3. Compare and merge

Choice (1-3):
----

== Examples

=== Interactive Mode (Recommended)

[source,bash]
----
# Run without arguments to enter interactive mode
/synchronize

# Interactive prompts appear:
# Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):
#
# Available agents:
#   1. project-builder         - Build and verify project with quality checks
#   2. code-reviewer          - Code review with standards compliance
#   3. adoc-review            - AsciiDoc documentation review
#   4. commit-current-changes - Git commit with standards
#   5. pr-handle-gemini       - Handle Gemini PR comments
#   6. pr-handle-sonar        - Handle Sonar issues
#   7. research-best-practices - Web research agent
#
# Selection [1-7, all, skip]: 1 3
#
# ✓ Selected: project-builder, adoc-review
#
# Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):
#
# Available commands:
#   1. agents-doctor              - Verify and fix agents
#   2. slash-doctor               - Verify commands
#   3. skills-doctor              - Verify skills
#   4. agents-create              - Create new agent
#   5. slash-create               - Create new command
#   6. skills-create              - Create new skill
#   7. setup-project-permissions  - Setup project permissions
#   8. docs-technical-adoc-review - Technical documentation review
#   9. handle-pull-request        - PR handling workflow
#  10. verify-plantuml-diagrams   - Verify PlantUML diagrams
#  11. verify-project             - Full project verification
#
# Selection [1-11, all, skip]: 1 7
#
# ✓ Selected: agents-doctor, setup-project-permissions
#
# Synchronizing 4 components to .claude/...
#
# ✓ Synchronized: .claude/agents/project-builder.md
# ✓ Synchronized: .claude/agents/adoc-review.md
# ✓ Synchronized: .claude/commands/agents-doctor.md
# ✓ Synchronized: .claude/commands/setup-project-permissions.md
#
# Next steps:
#   git add .claude/
#   git commit -m "sync: Add selected agents and commands"
#
# Note: Skills are accessed dynamically from repository (not synchronized)
----

=== Basic Synchronization (By Name)

[source,bash]
----
# Synchronize two agents by name
/synchronize project-builder adoc-review

# Output:
# ✓ Synchronized: .claude/agents/project-builder.md
# ✓ Synchronized: .claude/agents/adoc-review.md
#
# Next steps:
#   git add .claude/
#   git commit -m "sync: Add agents from cui-standards"
#
# Note: Agents reference skills from repository dynamically:
#   https://github.com/cuioss/cui-llm-rules
----

=== Selective Synchronization

[source,bash]
----
# Only commands
/synchronize --commands agents-doctor slash-doctor

# Only agents
/synchronize --agents project-builder code-reviewer
----

=== Full Synchronization

[source,bash]
----
# Synchronize everything
/synchronize --all

# Output:
# Synchronized 7 agents:
#   ✓ project-builder.md
#   ✓ adoc-review.md
#   [... 5 more ...]
#
# Synchronized 11 commands:
#   ✓ agents-doctor.md
#   ✓ slash-doctor.md
#   [... 9 more ...]
#
# Total: 18 components synchronized to .claude/
----

=== Update Existing

[source,bash]
----
# Update specific agent (force overwrite)
/synchronize project-builder --force

# Check what needs updates
/synchronize --check

# Update all out-of-date components
/synchronize --update
----
