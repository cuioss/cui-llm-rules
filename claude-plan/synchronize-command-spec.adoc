= Synchronize Command Specification
:toc: left
:toclevels: 3
:sectnums:

== Overview

The `/synchronize` command copies selected agents and commands from the plugin installation to the project's `.claude/` directory, making them available in git-controlled projects for all platforms (Claude Code, Claude.ai web, CI/CD).

== Purpose

**Problem**: Claude.ai web interface and CI/CD pipelines cannot install plugins.

**Solution**: Synchronize selected components to project's `.claude/` directory, which is git-controlled and available to all users/platforms.

== Architecture Integration

=== Component Distribution Model

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ PLUGIN (Claude Code only)                                   │
│ Location: ~/.claude/plugins/cui-standards/                  │
│ Purpose: Source for synchronization                         │
│                                                              │
│ ├── agents/           # Available for synchronization       │
│ └── commands/         # Available for synchronization       │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ /synchronize command
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ PROJECT .claude/ (Git-controlled)                           │
│ Location: /path/to/project/.claude/                         │
│ Purpose: Project-specific agents/commands for all platforms │
│                                                              │
│ ├── agents/           # Synchronized copies                 │
│ │   ├── project-builder.md                                  │
│ │   └── adoc-review.md                                      │
│ └── commands/         # Synchronized copies                 │
│     └── agents-doctor.md                                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Runtime skill resolution
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ REPOSITORY (All platforms)                                  │
│ Location: https://github.com/cuioss/cui-llm-rules           │
│ Purpose: Skills and standards (dynamically accessed)        │
│                                                              │
│ ├── skills/           # Read dynamically by agents          │
│ │   └── cui-java-standards/SKILL.md                         │
│ └── standards/        # Referenced by skills                │
│     └── java/java-code-standards.adoc                       │
└─────────────────────────────────────────────────────────────┘
----

=== Platform Support

[cols="1,1,2"]
|===
|Platform |Plugin Install |Synchronized .claude/ Access

|**Claude Code (CLI/IDE)**
|✅ Yes
|✅ Yes (overrides plugin)

|**Claude.ai Web**
|❌ No
|✅ Yes (only way to access)

|**GitHub Actions**
|❌ No
|✅ Yes (only way to access)

|**CI/CD Pipelines**
|❌ No
|✅ Yes (only way to access)
|===

== Command Specification

=== Command Definition

**File**: `commands/synchronize.md`

**YAML Frontmatter**:
[source,yaml]
----
---
description: Synchronize selected agents and commands from plugin to project .claude/ directory for git-controlled distribution
argument-hint: "[agent-name...] [--all] [--commands] [--agents]"
---
----

=== Syntax

[source,bash]
----
# Interactive mode (default - no arguments)
/synchronize

# Synchronize specific agents by name
/synchronize project-builder adoc-review

# Synchronize specific commands by name
/synchronize --commands agents-doctor slash-doctor

# Synchronize all agents
/synchronize --all --agents

# Synchronize all commands
/synchronize --all --commands

# Synchronize everything
/synchronize --all
----

=== Parameters

* **No arguments**: Interactive mode - displays numbered lists for selection
* **agent-name...**: Space-separated list of agent/command names to synchronize
* **--all**: Synchronize all available components
* **--agents**: Target agents only (default: both agents and commands)
* **--commands**: Target commands only
* **--force**: Overwrite existing files without confirmation

=== Interactive Mode

When invoked without arguments, `/synchronize` enters interactive mode:

[source]
----
$ /synchronize

Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):

Available agents:
  1. project-builder         - Build and verify project with quality checks
  2. code-reviewer          - Code review with standards compliance
  3. adoc-review            - AsciiDoc documentation review
  4. commit-current-changes - Git commit with standards
  5. pr-handle-gemini       - Handle Gemini PR comments
  6. pr-handle-sonar        - Handle Sonar issues
  7. research-best-practices - Web research agent

Selection [1-7, all, skip]: 1 3

✓ Selected: project-builder, adoc-review

Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):

Available commands:
  1. agents-doctor              - Verify and fix agents
  2. slash-doctor               - Verify commands
  3. skills-doctor              - Verify skills
  4. agents-create              - Create new agent
  5. slash-create               - Create new command
  6. skills-create              - Create new skill
  7. setup-project-permissions  - Setup project permissions
  8. docs-technical-adoc-review - Technical documentation review
  9. handle-pull-request        - PR handling workflow
 10. verify-plantuml-diagrams   - Verify PlantUML diagrams
 11. verify-project             - Full project verification

Selection [1-11, all, skip]: 1 7

✓ Selected: agents-doctor, setup-project-permissions

Synchronizing 4 components to .claude/...

✓ Synchronized: .claude/agents/project-builder.md
✓ Synchronized: .claude/agents/adoc-review.md
✓ Synchronized: .claude/commands/agents-doctor.md
✓ Synchronized: .claude/commands/setup-project-permissions.md

Next steps:
  git add .claude/
  git commit -m "sync: Add selected agents and commands"

Note: Skills are accessed dynamically from repository (not synchronized)
----

== Workflow

=== 1. Discovery Phase

[source]
----
1. Detect plugin installation location
   - Check ~/.claude/plugins/cui-standards/
   - Or use plugin API to get installation path

2. Scan available components
   - List all agents from plugin/agents/
   - List all commands from plugin/commands/

3. Validate target names
   - Verify requested components exist
   - Report missing components
----

=== 2. Synchronization Phase

[source]
----
1. Ensure project .claude/ directories exist
   - Create .claude/agents/ if needed
   - Create .claude/commands/ if needed

2. Copy requested components
   - Read from plugin location
   - Write to .claude/agents/ or .claude/commands/
   - Preserve file permissions

3. Update metadata
   - Add "Synchronized from: cui-standards plugin" header
   - Add "Synchronized date: YYYY-MM-DD" timestamp
   - Preserve original content
----

=== 3. Verification Phase

[source]
----
1. Verify copied files
   - Check file exists in .claude/
   - Validate YAML frontmatter
   - Verify skill references are valid

2. Report results
   - List synchronized components
   - Show file locations
   - Warn about skill references (must access repo dynamically)
----

== Synchronized File Format

=== Agent File Header

When synchronized, agents get a metadata header:

[source,markdown]
----
<!--
Synchronized from: cui-standards plugin
Synchronized date: 2025-10-22
Source: agents/project-builder.md

This is a project-local copy. To update, run: /synchronize project-builder

Skills referenced by this agent are accessed dynamically from repository:
https://github.com/cuioss/cui-llm-rules
-->

---
name: project-builder
description: Build and verify project...
tools: Read, Edit, Write, Bash
---

[Original agent content follows...]
----

=== Skill References Preserved

Synchronized agents maintain skill references:

[source,markdown]
----
## STANDARDS COMPLIANCE

**Before fixing code, READ these skills for current standards:**
- `cui-java-standards` skill - Java coding, Javadoc, null-safety
- `cui-testing-methodology` skill - Test coverage requirements

The Essential Rules above are core requirements. For complete standards,
consult the skills from repository.
----

**Note**: Skills are accessed dynamically from repository, NOT from plugin.

== Git Integration

=== .gitignore Configuration

**DO NOT ignore** `.claude/` directory:

[source,gitignore]
----
# .gitignore

# DO NOT ignore .claude/ - it contains synchronized agents/commands
# .claude/

# Only ignore local settings (if any)
.claude/settings.local.json
----

=== Commit Strategy

[source,bash]
----
# After synchronization
git add .claude/agents/
git add .claude/commands/

git commit -m "sync: Add project-builder and adoc-review agents

Synchronized from cui-standards plugin for cross-platform compatibility.
These agents reference skills dynamically from cui-llm-rules repository.

Agents:
- project-builder: Build verification with quality checks
- adoc-review: Documentation review and validation"
----

=== Team Collaboration

**Workflow**:

1. **Developer A** (has Claude Code):
   ```bash
   # Install plugin
   /plugin install cui-standards@cui-llm-rules

   # Synchronize to project
   cd ~/project
   /synchronize project-builder adoc-review

   # Commit to git
   git add .claude/
   git commit -m "sync: Add agents for project"
   git push
   ```

2. **Developer B** (uses Claude.ai web):
   ```bash
   # Pull project
   git pull

   # .claude/ agents are now available
   # Uses them directly in Claude.ai web interface
   # Skills resolved from repository dynamically
   ```

3. **CI/CD Pipeline**:
   ```yaml
   # GitHub Action workflow
   - uses: actions/checkout@v4
   # .claude/ agents available in workspace
   # Skills accessed from repository
   ```

== Update Strategy

=== Updating Synchronized Components

When plugin updates:

[source,bash]
----
# Update plugin
/plugin marketplace update cui-llm-rules

# Re-synchronize to get updates
/synchronize project-builder --force

# Review changes
git diff .claude/agents/project-builder.md

# Commit if acceptable
git add .claude/agents/
git commit -m "sync: Update project-builder to latest version"
----

=== Selective Updates

[source,bash]
----
# Check which components need updates
/synchronize --check

# Output:
# ✓ project-builder.md - up to date
# ⚠ adoc-review.md - newer version available (2025-10-22 vs 2025-10-15)
# ⚠ agents-doctor.md - newer version available

# Update only specific components
/synchronize adoc-review agents-doctor --force
----

== Skills Access Pattern

=== Skills Are Never Synchronized

**IMPORTANT**: Skills are NEVER copied to `.claude/`. They are always accessed dynamically from the repository.

**Rationale**:
- Skills reference standards that change frequently
- Synchronizing creates drift risk
- Dynamic access ensures always-current data
- Smaller .claude/ directory size

=== How Skills Are Accessed

See xref:architecture-overview.adoc#skills-access-mechanism[Architecture Overview § Skills Access Mechanism] for complete details on how Claude accesses skills from plugin installations (Claude Code) or repository (Claude.ai web, CI/CD).

== Command Implementation Pseudocode

[source,python]
----
def synchronize(components, options):
    # 1. Discover plugin location
    plugin_path = find_plugin_installation("cui-standards")
    if not plugin_path:
        error("Plugin not installed. Run: /plugin install cui-standards@cui-llm-rules")

    # 2. Resolve component names
    agents_to_sync = []
    commands_to_sync = []

    if not components and not options.all:
        # Interactive mode - no arguments provided
        agents_to_sync, commands_to_sync = interactive_selection(plugin_path)
    elif options.all:
        agents_to_sync = list_all_agents(plugin_path)
        commands_to_sync = list_all_commands(plugin_path)
    elif options.agents:
        agents_to_sync = components
    elif options.commands:
        commands_to_sync = components
    else:
        # Auto-detect type by name
        agents_to_sync, commands_to_sync = classify_components(components)

def interactive_selection(plugin_path):
    """Interactive mode with numbered selection"""

    # 1. Get available components
    available_agents = discover_agents(plugin_path)
    available_commands = discover_commands(plugin_path)

    # 2. Display agents menu
    print("Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):")
    print()
    print("Available agents:")
    for i, agent in enumerate(available_agents, 1):
        description = get_description(f"{plugin_path}/agents/{agent}.md")
        print(f"  {i:2d}. {agent:25s} - {description}")

    print()
    agent_selection = input(f"Selection [1-{len(available_agents)}, all, skip]: ").strip()

    selected_agents = []
    if agent_selection.lower() == 'all':
        selected_agents = available_agents
    elif agent_selection.lower() != 'skip':
        # Parse numbers
        numbers = parse_selection(agent_selection)
        selected_agents = [available_agents[n-1] for n in numbers if 1 <= n <= len(available_agents)]

    if selected_agents:
        print(f"✓ Selected: {', '.join(selected_agents)}")
        print()

    # 3. Display commands menu
    print("Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):")
    print()
    print("Available commands:")
    for i, command in enumerate(available_commands, 1):
        description = get_description(f"{plugin_path}/commands/{command}.md")
        print(f"  {i:2d}. {command:28s} - {description}")

    print()
    command_selection = input(f"Selection [1-{len(available_commands)}, all, skip]: ").strip()

    selected_commands = []
    if command_selection.lower() == 'all':
        selected_commands = available_commands
    elif command_selection.lower() != 'skip':
        # Parse numbers
        numbers = parse_selection(command_selection)
        selected_commands = [available_commands[n-1] for n in numbers if 1 <= n <= len(available_commands)]

    if selected_commands:
        print(f"✓ Selected: {', '.join(selected_commands)}")
        print()

    return selected_agents, selected_commands

def parse_selection(input_str):
    """Parse space-separated numbers from user input"""
    numbers = []
    for part in input_str.split():
        try:
            numbers.append(int(part))
        except ValueError:
            pass  # Ignore non-numeric input
    return numbers

def discover_agents(plugin_path):
    """Get list of agent names from plugin"""
    agents = []
    agents_dir = f"{plugin_path}/agents"
    for file in list_files(agents_dir):
        if file.endswith('.md'):
            agents.append(file[:-3])  # Remove .md extension
    return sorted(agents)

def discover_commands(plugin_path):
    """Get list of command names from plugin"""
    commands = []
    commands_dir = f"{plugin_path}/commands"
    for file in list_files(commands_dir):
        if file.endswith('.md'):
            commands.append(file[:-3])  # Remove .md extension
    return sorted(commands)

def get_description(file_path):
    """Extract description from YAML frontmatter or first line"""
    content = read_file(file_path)

    # Try to extract from YAML frontmatter
    if content.startswith('---'):
        lines = content.split('\n')
        for line in lines[1:]:
            if line.startswith('description:'):
                return line.split(':', 1)[1].strip().strip('"\'')
            if line.strip() == '---':
                break

    # Fallback: use first non-empty line after frontmatter/comments
    for line in content.split('\n'):
        if line.strip() and not line.startswith('#') and not line.startswith('<!--'):
            return line.strip()[:60]  # First 60 chars

    return "No description"

    # 3. Ensure .claude/ directories exist
    ensure_directory_exists(".claude/agents")
    ensure_directory_exists(".claude/commands")

    # 4. Synchronize each component
    results = []
    for agent in agents_to_sync:
        result = copy_component(
            source=f"{plugin_path}/agents/{agent}.md",
            dest=f".claude/agents/{agent}.md",
            force=options.force
        )
        results.append(result)

    for command in commands_to_sync:
        result = copy_component(
            source=f"{plugin_path}/commands/{command}.md",
            dest=f".claude/commands/{command}.md",
            force=options.force
        )
        results.append(result)

    # 5. Report results
    print_summary(results)
    print_git_instructions()
    print_skill_access_reminder()

def copy_component(source, dest, force):
    # Check if destination exists
    if exists(dest) and not force:
        if not confirm(f"Overwrite {dest}?"):
            return {"status": "skipped", "file": dest}

    # Read source
    content = read_file(source)

    # Add synchronization metadata
    metadata = f"""<!--
Synchronized from: cui-standards plugin
Synchronized date: {today()}
Source: {source}

To update: /synchronize {basename(dest, '.md')} --force
-->

"""

    # Write to destination
    write_file(dest, metadata + content)

    return {"status": "synchronized", "file": dest}
----

== Error Handling

=== Plugin Not Installed

[source]
----
Error: cui-standards plugin not installed

Install plugin first:
  /plugin install cui-standards@cui-llm-rules

Or specify custom source path:
  /synchronize --source ~/custom-path project-builder
----

=== Component Not Found

[source]
----
Error: Component 'invalid-agent' not found

Available agents:
  - project-builder
  - adoc-review
  - commit-current-changes
  - code-reviewer

Available commands:
  - agents-doctor
  - slash-doctor
  - skills-doctor
----

=== Destination Exists

[source]
----
Warning: .claude/agents/project-builder.md already exists

Options:
  1. Skip (keep existing)
  2. Overwrite (use --force)
  3. Compare and merge

Choice (1-3):
----

== Examples

=== Interactive Mode (Recommended)

[source,bash]
----
# Run without arguments to enter interactive mode
/synchronize

# Interactive prompts appear:
# Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):
#
# Available agents:
#   1. project-builder         - Build and verify project with quality checks
#   2. code-reviewer          - Code review with standards compliance
#   3. adoc-review            - AsciiDoc documentation review
#   4. commit-current-changes - Git commit with standards
#   5. pr-handle-gemini       - Handle Gemini PR comments
#   6. pr-handle-sonar        - Handle Sonar issues
#   7. research-best-practices - Web research agent
#
# Selection [1-7, all, skip]: 1 3
#
# ✓ Selected: project-builder, adoc-review
#
# Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):
#
# Available commands:
#   1. agents-doctor              - Verify and fix agents
#   2. slash-doctor               - Verify commands
#   3. skills-doctor              - Verify skills
#   4. agents-create              - Create new agent
#   5. slash-create               - Create new command
#   6. skills-create              - Create new skill
#   7. setup-project-permissions  - Setup project permissions
#   8. docs-technical-adoc-review - Technical documentation review
#   9. handle-pull-request        - PR handling workflow
#  10. verify-plantuml-diagrams   - Verify PlantUML diagrams
#  11. verify-project             - Full project verification
#
# Selection [1-11, all, skip]: 1 7
#
# ✓ Selected: agents-doctor, setup-project-permissions
#
# Synchronizing 4 components to .claude/...
#
# ✓ Synchronized: .claude/agents/project-builder.md
# ✓ Synchronized: .claude/agents/adoc-review.md
# ✓ Synchronized: .claude/commands/agents-doctor.md
# ✓ Synchronized: .claude/commands/setup-project-permissions.md
#
# Next steps:
#   git add .claude/
#   git commit -m "sync: Add selected agents and commands"
#
# Note: Skills are accessed dynamically from repository (not synchronized)
----

=== Basic Synchronization (By Name)

[source,bash]
----
# Synchronize two agents by name
/synchronize project-builder adoc-review

# Output:
# ✓ Synchronized: .claude/agents/project-builder.md
# ✓ Synchronized: .claude/agents/adoc-review.md
#
# Next steps:
#   git add .claude/
#   git commit -m "sync: Add agents from cui-standards"
#
# Note: Agents reference skills from repository dynamically:
#   https://github.com/cuioss/cui-llm-rules
----

=== Selective Synchronization

[source,bash]
----
# Only commands
/synchronize --commands agents-doctor slash-doctor

# Only agents
/synchronize --agents project-builder code-reviewer
----

=== Full Synchronization

[source,bash]
----
# Synchronize everything
/synchronize --all

# Output:
# Synchronized 7 agents:
#   ✓ project-builder.md
#   ✓ adoc-review.md
#   [... 5 more ...]
#
# Synchronized 11 commands:
#   ✓ agents-doctor.md
#   ✓ slash-doctor.md
#   [... 9 more ...]
#
# Total: 18 components synchronized to .claude/
----

=== Update Existing

[source,bash]
----
# Update specific agent (force overwrite)
/synchronize project-builder --force

# Check what needs updates
/synchronize --check

# Update all out-of-date components
/synchronize --update
----
