= Synchronize Command Specification
:toc: left
:toclevels: 3
:sectnums:

== Overview

The `/synchronize` command copies selected agents and commands from the plugin installation to the project's `.claude/` directory, making them available in git-controlled projects for all platforms (Claude Code, Claude.ai web, CI/CD).

== Purpose

**Problem**: Claude.ai web interface and CI/CD pipelines cannot install plugins.

**Solution**: Synchronize selected components to project's `.claude/` directory, which is git-controlled and available to all users/platforms.

== Architecture Integration

=== Component Distribution Model

[source]
----
┌─────────────────────────────────────────────────────────────┐
│ PLUGIN (Claude Code only)                                   │
│ Location: ~/.claude/plugins/cui-standards/                  │
│ Purpose: Source for synchronization                         │
│                                                              │
│ ├── agents/           # Available for synchronization       │
│ └── commands/         # Available for synchronization       │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ /synchronize command
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ PROJECT .claude/ (Git-controlled)                           │
│ Location: /path/to/project/.claude/                         │
│ Purpose: Project-specific components for all platforms      │
│                                                              │
│ ├── agents/           # Synchronized copies                 │
│ │   ├── project-builder.md                                  │
│ │   └── adoc-review.md                                      │
│ ├── commands/         # Synchronized copies                 │
│ │   └── agents-doctor.md                                    │
│ └── skills/           # Synchronized copies (RECOMMENDED)   │
│     └── cui-java-standards/SKILL.md                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Skills read standards dynamically
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ REPOSITORY (Plugin source)                                  │
│ Location: https://github.com/cuioss/cui-llm-rules           │
│ Purpose: Standards (referenced by synchronized skills)      │
│                                                              │
│ └── standards/        # Referenced by skills via Read tool  │
│     └── java/java-code-standards.adoc                       │
└─────────────────────────────────────────────────────────────┘
----

=== Platform Support

For complete platform support information, see xref:architecture-overview.adoc#implementation-decision-guide[Architecture Overview § Implementation Decision Guide].

**Summary**: Project `.claude/` (synchronized) works on ALL platforms. Plugin installation works only on Claude Code CLI/IDE.

== Command Specification

=== Command Definition

**File**: `commands/synchronize.md`

**YAML Frontmatter**:
[source,yaml]
----
---
description: Synchronize selected agents and commands from plugin to project .claude/ directory for git-controlled distribution
argument-hint: "[agent-name...] [--all] [--commands] [--agents]"
---
----

=== Syntax

[source,bash]
----
# Interactive mode (default - no arguments)
/synchronize

# Synchronize specific agents by name
/synchronize project-builder adoc-review

# Synchronize specific commands by name
/synchronize --commands agents-doctor slash-doctor

# Synchronize all agents
/synchronize --all --agents

# Synchronize all commands
/synchronize --all --commands

# Synchronize everything (agents + commands + skills)
/synchronize --all --include-skills

# Synchronize everything except skills
/synchronize --all

# Check what needs updates (no changes made)
/synchronize --check

# Update all out-of-date components
/synchronize --update
----

=== Parameters

* **No arguments**: Interactive mode - displays numbered lists for selection
* **agent-name...**: Space-separated list of agent/command names to synchronize
* **--all**: Synchronize all available components
* **--agents**: Target agents only (default: both agents and commands)
* **--commands**: Target commands only
* **--include-skills**: Also synchronize skills to `.claude/skills/` (recommended)
* **--force**: Overwrite existing files without confirmation
* **--check**: Check which components need updates (don't modify files)
* **--update**: Update all out-of-date components (implies --check, then synchronize outdated)

=== Interactive Mode

When invoked without arguments, `/synchronize` enters interactive mode:

[source]
----
$ /synchronize

Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):

Available agents:
  1. project-builder         - Build and verify project with quality checks
  2. code-reviewer          - Code review with standards compliance
  3. adoc-review            - AsciiDoc documentation review
  4. commit-current-changes - Git commit with standards
  5. pr-handle-gemini       - Handle Gemini PR comments
  6. pr-handle-sonar        - Handle Sonar issues
  7. research-best-practices - Web research agent

Selection [1-7, all, skip]: 1 3

✓ Selected: project-builder, adoc-review

Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):

Available commands:
  1. agents-doctor              - Verify and fix agents
  2. slash-doctor               - Verify commands
  3. skills-doctor              - Verify skills
  4. agents-create              - Create new agent
  5. slash-create               - Create new command
  6. skills-create              - Create new skill
  7. setup-project-permissions  - Setup project permissions
  8. docs-technical-adoc-review - Technical documentation review
  9. handle-pull-request        - PR handling workflow
 10. verify-plantuml-diagrams   - Verify PlantUML diagrams
 11. verify-project             - Full project verification

Selection [1-11, all, skip]: 1 7

✓ Selected: agents-doctor, setup-project-permissions

Synchronizing 4 components to .claude/...

✓ Synchronized: .claude/agents/project-builder.md
✓ Synchronized: .claude/agents/adoc-review.md
✓ Synchronized: .claude/commands/agents-doctor.md
✓ Synchronized: .claude/commands/setup-project-permissions.md

Next steps:
  git add .claude/
  git commit -m "sync: Add selected agents and commands"

IMPORTANT: Don't forget to synchronize skills for cross-platform support:
  /synchronize --all --include-skills
----

=== Interactive Mode: Input Validation

The interactive mode accepts various input formats and handles errors gracefully:

==== Valid Input Formats

**Space-separated numbers**:
```
Selection: 1 3 5
```

**Comma-separated numbers**:
```
Selection: 1, 3, 5
```

**Ranges** (not currently supported - feature request):
```
Selection: 1-5    # Future: Select items 1 through 5
```

**Special keywords**:
```
Selection: all    # Select all items
Selection: skip   # Skip this category
Selection: none   # Same as skip
Selection: cancel # Cancel entire operation
```

==== Invalid Input Handling

**Out of range numbers**:
```
Selection [1-7]: 10

❌ Error: Selection 10 is out of range (1-7)
Please try again:
```

**Invalid format**:
```
Selection: abc

❌ Error: Invalid input format. Use numbers (1 3 5), 'all', or 'skip'
Please try again:
```

**Empty input** (press Enter without typing):
```
Selection:

❌ Error: No selection made. Use numbers, 'all', 'skip', or 'cancel'
Please try again:
```

**Mixed valid/invalid**:
```
Selection: 1 3 99

⚠️  Warning: Ignoring invalid selection: 99 (out of range)
✓ Selected: 1, 3
Continue? [y/N]:
```

==== Cancellation

User can cancel at any prompt:

```
Selection: cancel

Synchronization cancelled. No changes made.
```

Or use Ctrl+C:

```
Selection: ^C

Synchronization interrupted. No changes made.
```

==== Confirmation Before Writing

Before writing files, show summary and confirm:

```
Ready to synchronize 4 components:

Agents (2):
  - project-builder.md
  - adoc-review.md

Commands (2):
  - agents-doctor.md
  - setup-project-permissions.md

This will write/overwrite files in .claude/
Proceed? [y/N]:
```

* `y` or `yes` - Proceed with synchronization
* `n`, `no`, or Enter - Cancel operation
* Any other input - Treated as 'no', cancel operation

== Workflow

=== 1. Discovery Phase

[source]
----
1. Detect plugin installation location
   - Check ~/.claude/plugins/cui-standards/
   - Or use plugin API to get installation path

2. Scan available components
   - List all agents from plugin/agents/
   - List all commands from plugin/commands/

3. Validate target names
   - Verify requested components exist
   - Report missing components
----

=== 2. Synchronization Phase

[source]
----
1. Ensure project .claude/ directories exist
   - Create .claude/agents/ if needed
   - Create .claude/commands/ if needed

2. Copy requested components
   - Read from plugin location
   - Write to .claude/agents/ or .claude/commands/
   - Preserve file permissions

3. Update metadata
   - Add "Synchronized from: cui-standards plugin" header
   - Add "Synchronized date: YYYY-MM-DD" timestamp
   - Preserve original content
----

=== 3. Verification Phase

[source]
----
1. Verify copied files
   - Check file exists in .claude/
   - Validate YAML frontmatter
   - Verify skill references are valid

2. Report results
   - List synchronized components
   - Show file locations
   - Warn about skill references (must access repo dynamically)
----

== Synchronized File Format

=== Agent File Header

When synchronized, agents get a metadata header:

[source,markdown]
----
<!--
Synchronized from: cui-standards plugin
Synchronized date: 2025-10-22
Source: agents/project-builder.md

This is a project-local copy. To update, run: /synchronize project-builder

Skills referenced by this agent should be synchronized to .claude/skills/:
  /synchronize --all --include-skills
-->

---
name: project-builder
description: Build and verify project...
tools: Read, Edit, Write, Bash
---

[Original agent content follows...]
----

=== Skill References Preserved

Synchronized agents maintain skill references:

[source,markdown]
----
## STANDARDS COMPLIANCE

**Before fixing code, READ these skills for current standards:**
- `cui-java-standards` skill - Java coding, Javadoc, null-safety
- `cui-testing-methodology` skill - Test coverage requirements

The Essential Rules above are core requirements. For complete standards,
consult the skills.
----

**Note**: Skills should be synchronized to `.claude/skills/` using `/synchronize --include-skills` for cross-platform availability.

== Git Integration

=== .gitignore Configuration

**DO NOT ignore** `.claude/` directory:

[source,gitignore]
----
# .gitignore

# DO NOT ignore .claude/ - it contains synchronized agents/commands
# .claude/

# Only ignore local settings (if any)
.claude/settings.local.json
----

=== Commit Strategy

[source,bash]
----
# After synchronization
git add .claude/agents/
git add .claude/commands/

git commit -m "sync: Add project-builder and adoc-review agents

Synchronized from cui-standards plugin for cross-platform compatibility.
These agents reference skills dynamically from cui-llm-rules repository.

Agents:
- project-builder: Build verification with quality checks
- adoc-review: Documentation review and validation"
----

=== Team Collaboration

**Workflow**:

1. **Developer A** (has Claude Code):
   ```bash
   # Install plugin
   /plugin install cui-standards@cui-llm-rules

   # Synchronize to project
   cd ~/project
   /synchronize project-builder adoc-review

   # Commit to git
   git add .claude/
   git commit -m "sync: Add agents for project"
   git push
   ```

2. **Developer B** (uses Claude.ai web):
   ```bash
   # Pull project
   git pull

   # .claude/ agents, commands, and skills are now available
   # Uses them directly in Claude.ai web interface
   # Skills reference standards from repository dynamically
   ```

3. **CI/CD Pipeline**:
   ```yaml
   # GitHub Action workflow
   - uses: actions/checkout@v4
   # .claude/ agents, commands, and skills available in workspace
   # Skills access standards from repository via Read tool
   ```

== Update Strategy

=== Updating Synchronized Components

When plugin updates:

[source,bash]
----
# Update plugin
/plugin marketplace update cui-llm-rules

# Re-synchronize to get updates
/synchronize project-builder --force

# Review changes
git diff .claude/agents/project-builder.md

# Commit if acceptable
git add .claude/agents/
git commit -m "sync: Update project-builder to latest version"
----

=== Checking for Updates

The `--check` flag reports which synchronized components are out of date without modifying files:

[source,bash]
----
# Check which components need updates
/synchronize --check

# Output:
# Checking synchronized components in .claude/...
#
# Agents:
#   ✓ project-builder.md - up to date (synced: 2025-10-22, plugin: 2025-10-22)
#   ⚠ adoc-review.md - update available (synced: 2025-10-15, plugin: 2025-10-22)
#   ⚠ code-reviewer.md - update available (synced: 2025-10-15, plugin: 2025-10-20)
#
# Commands:
#   ✓ agents-doctor.md - up to date
#   ⚠ synchronize.md - update available
#
# Skills:
#   ⚠ cui-java-standards - update available (synced: 2025-10-10, plugin: 2025-10-22)
#
# Summary: 4 components need updates

# Update all out-of-date components automatically
/synchronize --update

# Or update specific components
/synchronize adoc-review code-reviewer synchronize --force
----

**How --check Works**:

1. Reads `Synchronized date:` from synchronized file header comments
2. Compares with plugin file modification dates
3. Reports status for each component
4. Returns exit code 0 if all up-to-date, 1 if updates available

**How --update Works**:

1. Runs `--check` internally to identify outdated components
2. Synchronizes all outdated components (equivalent to `--force`)
3. Skips components already up-to-date
4. Reports summary of updated components

== Skills Synchronization

=== Current Recommendation (Strategy 1)

**IMPORTANT**: Skills MUST be synchronized to `.claude/skills/` for reliable cross-platform operation.

[source,bash]
----
# Synchronize everything including skills (RECOMMENDED)
/synchronize --all --include-skills

# This copies:
# - Agents → .claude/agents/
# - Commands → .claude/commands/
# - Skills → .claude/skills/
----

**Why synchronize skills?**

* ✅ Works on ALL platforms (Claude Code, Claude.ai web, CI/CD)
* ✅ Team members without plugin installation can use skills
* ✅ Git-controlled versions ensure consistency
* ✅ No network dependencies at runtime

**Why this is the only recommended approach**: See xref:architecture-overview.adoc#skills-distribution-strategy[Architecture Overview § Skills Distribution Strategy] for architectural background and comparison with theoretical alternatives.

This synchronization-based approach is:
* ✅ Verified and tested on all platforms
* ✅ The ONLY approach recommended for use
* ✅ Simple and proven (same mechanism as agents/commands)

=== Managing Drift

Since synchronized skills can become outdated when the plugin is updated, follow these practices:

==== Detection

Use the `--check` flag to detect outdated components:

[source,bash]
----
/synchronize --check

# Output shows which components need updates:
# ✓ project-builder.md - up to date
# ⚠ cui-java-standards - update available (synced: 2025-10-15, plugin: 2025-10-22)
----

**How it works**:
* Reads `Synchronized date:` from file header comments
* Compares with plugin file modification dates
* Reports status for each component

==== Update Frequency

**Recommended schedule**:
* After each plugin update: `/plugin marketplace update cui-llm-rules` → `/synchronize --check`
* Before starting new feature work (ensure current standards)
* When standards violations appear (may indicate outdated rules)

**Automation**: Consider adding to git hooks or CI/CD pipeline

==== Review Changes Before Applying

[source,bash]
----
# Step 1: Update plugin
/plugin marketplace update cui-llm-rules

# Step 2: Check for updates
/synchronize --check

# Step 3: Review changes in plugin
cd ~/.claude/plugins/cui-standards/
git log  # (if plugin repo is git-cloned)

# Step 4: Apply updates
/synchronize --update  # Updates all outdated components
# OR
/synchronize --all --include-skills --force  # Force update everything

# Step 5: Review diffs before committing
git diff .claude/

# Step 6: Commit if acceptable
git add .claude/
git commit -m "sync: Update cui-standards components to v1.2.0"
----

==== Testing After Sync

After synchronizing updates:

1. **Verify agents still work**: Run one agent to ensure no breaking changes
2. **Check skills load**: Verify skill files are valid
3. **Test in CI/CD**: If using automated pipelines, verify they still pass
4. **Update team**: Notify team members to pull changes

== Implementation Algorithm

High-level implementation approach:

. **Discovery Phase**
   * Locate plugin installation (`~/.claude/plugins/cui-standards/`)
   * Scan available agents and commands
   * Validate requested component names

. **Selection Phase**
   * **Interactive mode** (no arguments): Display numbered menus for agents and commands
   * **Command-line mode**: Parse arguments for specific components or `--all`
   * Extract descriptions from YAML frontmatter for display

. **Synchronization Phase**
   * Create `.claude/agents/` and `.claude/commands/` directories if needed
   * Copy selected components from plugin to project
   * Add synchronization metadata header (source, date, update command)
   * Preserve YAML frontmatter and content

. **Verification Phase**
   * Verify copied files exist and are valid
   * Report results with file locations
   * Display git commit instructions
   * Note about skills access mechanism

**Key Functions**:

* `discover_components(path)`: List agents/commands from plugin directory
* `interactive_selection()`: Display numbered menus, parse user input
* `copy_component(source, dest)`: Copy file with metadata header
* `validate_component(path)`: Check YAML frontmatter validity

== Error Handling

=== Plugin Not Installed

[source]
----
Error: cui-standards plugin not installed

Install plugin first:
  /plugin install cui-standards@cui-llm-rules

Or specify custom source path:
  /synchronize --source ~/custom-path project-builder
----

=== Component Not Found

[source]
----
Error: Component 'invalid-agent' not found

Available agents:
  - project-builder
  - adoc-review
  - commit-current-changes
  - code-reviewer

Available commands:
  - agents-doctor
  - slash-doctor
  - skills-doctor
----

=== Destination Exists

[source]
----
Warning: .claude/agents/project-builder.md already exists

Options:
  1. Skip (keep existing)
  2. Overwrite (use --force)
  3. Compare and merge

Choice (1-3):
----

== Examples

=== Interactive Mode (Recommended)

[source,bash]
----
# Run without arguments to enter interactive mode
/synchronize

# Interactive prompts appear:
# Select agents to synchronize (space-separated numbers, or 'all', or 'skip'):
#
# Available agents:
#   1. project-builder         - Build and verify project with quality checks
#   2. code-reviewer          - Code review with standards compliance
#   3. adoc-review            - AsciiDoc documentation review
#   4. commit-current-changes - Git commit with standards
#   5. pr-handle-gemini       - Handle Gemini PR comments
#   6. pr-handle-sonar        - Handle Sonar issues
#   7. research-best-practices - Web research agent
#
# Selection [1-7, all, skip]: 1 3
#
# ✓ Selected: project-builder, adoc-review
#
# Select commands to synchronize (space-separated numbers, or 'all', or 'skip'):
#
# Available commands:
#   1. agents-doctor              - Verify and fix agents
#   2. slash-doctor               - Verify commands
#   3. skills-doctor              - Verify skills
#   4. agents-create              - Create new agent
#   5. slash-create               - Create new command
#   6. skills-create              - Create new skill
#   7. setup-project-permissions  - Setup project permissions
#   8. docs-technical-adoc-review - Technical documentation review
#   9. handle-pull-request        - PR handling workflow
#  10. verify-plantuml-diagrams   - Verify PlantUML diagrams
#  11. verify-project             - Full project verification
#
# Selection [1-11, all, skip]: 1 7
#
# ✓ Selected: agents-doctor, setup-project-permissions
#
# Synchronizing 4 components to .claude/...
#
# ✓ Synchronized: .claude/agents/project-builder.md
# ✓ Synchronized: .claude/agents/adoc-review.md
# ✓ Synchronized: .claude/commands/agents-doctor.md
# ✓ Synchronized: .claude/commands/setup-project-permissions.md
#
# Next steps:
#   git add .claude/
#   git commit -m "sync: Add selected agents and commands"
#
# IMPORTANT: Don't forget to synchronize skills for cross-platform support:
#   /synchronize --all --include-skills
----

=== Basic Synchronization (By Name)

[source,bash]
----
# Synchronize two agents by name
/synchronize project-builder adoc-review

# Output:
# ✓ Synchronized: .claude/agents/project-builder.md
# ✓ Synchronized: .claude/agents/adoc-review.md
#
# Next steps:
#   git add .claude/
#   git commit -m "sync: Add agents from cui-standards"
#
# Note: Also synchronize skills for complete cross-platform support:
#   /synchronize --all --include-skills
----

=== Selective Synchronization

[source,bash]
----
# Only commands
/synchronize --commands agents-doctor slash-doctor

# Only agents
/synchronize --agents project-builder code-reviewer
----

=== Full Synchronization

[source,bash]
----
# Synchronize everything
/synchronize --all

# Output:
# Synchronized 7 agents:
#   ✓ project-builder.md
#   ✓ adoc-review.md
#   [... 5 more ...]
#
# Synchronized 11 commands:
#   ✓ agents-doctor.md
#   ✓ slash-doctor.md
#   [... 9 more ...]
#
# Total: 18 components synchronized to .claude/
----

=== Update Existing

[source,bash]
----
# Update specific agent (force overwrite)
/synchronize project-builder --force

# Check what needs updates
/synchronize --check

# Update all out-of-date components
/synchronize --update
----
