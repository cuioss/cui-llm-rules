= Component Specifications
:toc: left
:toclevels: 3
:sectnums:

== Introduction

This document specifies the technical structure and format requirements for Skills, Agents, and Commands in the cui-standards plugin.

== Skill Specifications

=== Skill Structure

Skills are knowledge layers that provide Claude with context and methodology by referencing standards documentation.

==== File Format

* **Primary File**: `SKILL.md` (required)
* **Location**: `skills/skill-name/SKILL.md`
* **Format**: Markdown with YAML frontmatter

==== YAML Frontmatter

Skills use YAML frontmatter to define metadata.

**Required fields**:

* **name**: Display name of the skill
* **description**: Clear, specific description for context matching

**Optional fields**:

* **allowed-tools**: Comma-separated list of tools (e.g., `Read, Grep, Glob`)

**Example**:
[source,yaml]
----
---
name: Skill Name
description: Clear description that triggers auto-activation based on context
allowed-tools: Read  # Optional: Read-only recommended for knowledge skills
---
----

For field specifications shared across components, see xref:#yaml-frontmatter-common-fields[Common YAML Frontmatter Fields].

==== Progressive Disclosure

Skills load progressively:

. **Startup**: Name + description (30-50 tokens)
. **Context Matching**: Claude determines relevance
. **Dynamic Fetch**: Read tool loads content when needed

=== Skill Directory Structure

[source]
----
skills/skill-name/
├── SKILL.md                  # Main skill definition (required)
├── README.md                 # Usage documentation (optional)
├── templates/                # Code templates (optional)
│   ├── template1.java
│   └── template2.java
├── examples/                 # Working examples (optional)
│   └── example1.java
└── checklists/               # Verification checklists (optional)
    └── checklist.md
----

=== Example: CUI Java Standards Skill

==== File: `skills/cui-java-standards/SKILL.md`

[source,yaml]
----
---
name: CUI Java Standards
description: Provides CUI Java development standards including coding patterns, logging, testing, null-safety, Lombok usage, and Javadoc requirements. Use when writing, reviewing, or refactoring Java code for CUI projects.
allowed-tools: Read
---
----

==== Standards References

All paths must be relative to plugin root:

[source,markdown]
----
## Standards Reference

**Primary Standards:**
- Java Code: `./standards/java/java-code-standards.adoc`
- Testing: `./standards/testing/core-standards.adoc`
- Javadoc: `./standards/documentation/javadoc-standards.adoc`
- Process: `./standards/process/task-completion-standards.adoc`

**Important**: All paths MUST be relative to plugin/repository root and start with `./`

For path resolution details, see xref:plugin-structure.adoc#path-resolution[Plugin Structure § Path Resolution].
----

==== Quick Reference Pattern

Skills should provide quick reference sections for common requirements:

[source,markdown]
----
## Quick Reference

### Logging Standards (MANDATORY)
**Source**: `standards/logging/core-standards.adoc`

- **Logger Declaration**: `private static final CuiLogger LOGGER = new CuiLogger(...)`
- **Never use**: System.out, System.err, slf4j directly
- **Parameterized messages**: Use `%s` for all substitutions
----

==== Usage Patterns

[source,markdown]
----
## Usage Patterns

### For Claude (Main Conversation)
When user asks about Java standards:
1. Activate this skill automatically (based on description triggers)
2. Read relevant standards files for complete information
3. Apply quick reference for common questions
4. Provide templates for code generation

### For Agents
Agents should reference this skill in their system prompts.
----

== Agent Specifications

=== Agent Structure

Agents are autonomous task executors that combine embedded Essential Rules with skill references.

==== File Format

* **File**: `agent-name.md`
* **Location**: `agents/agent-name.md`
* **Format**: Markdown with YAML frontmatter

==== YAML Frontmatter

Agents use YAML frontmatter to define metadata and configuration.

**Required fields**:

* **name**: Agent identifier
* **description**: When to use this agent (triggers proactive activation)

**Optional fields**:

* **tools**: Comma-separated list (e.g., `Read, Edit, Write, Bash`); inherits all if omitted
* **model**: Specific model (e.g., `sonnet`, `haiku`)
* **color**: Terminal output color (e.g., `green`, `blue`)

**Example**:
[source,yaml]
----
---
name: agent-name
description: Clear description of when to use this agent. This agent should be used proactively when...
tools: Read, Edit, Write, Bash
model: sonnet
color: green
---
----

For field specifications shared across components, see xref:#yaml-frontmatter-common-fields[Common YAML Frontmatter Fields].

=== Essential Rules Pattern (Custom Implementation)

**IMPORTANT**: This is a **MANUAL PATTERN** created for this plugin, NOT a native Claude Code feature.

==== What "Custom Implementation" Means

The Essential Rules Pattern is a **convention** that requires manual work:

* **NOT automated** - No Claude Code feature automatically extracts or embeds rules
* **Manual extraction** - You must read standards files and extract core requirements
* **Manual embedding** - You must paste extracted rules into agent files
* **Manual maintenance** - You must keep embedded rules synchronized with source
* **Tool support optional** - `/agents-doctor sync` command helps detect drift but requires manual approval

**Why use this pattern?**

* **Performance**: Agents load faster with embedded rules (no I/O to read standards)
* **Autonomy**: Agents can execute without blocking on skill reads
* **Reliability**: Core rules always available even if skills access fails
* **Completeness**: Skills provide full standards; embedded rules ensure minimum requirements

**Trade-offs**:

* ❌ Duplication between standards and embedded rules (drift risk)
* ❌ Manual synchronization required when standards change
* ✅ Fast agent startup and execution
* ✅ Self-contained agents that work offline

==== Pattern Structure

[source,markdown]
----
## ESSENTIAL RULES

### JavaDoc Standards
Source: ./standards/documentation/javadoc-standards.adoc
Last Synced: 2025-10-22

**Package Documentation**:
- Every package must have package-info.java
- Package documentation must describe the package purpose

**Class/Interface Documentation**:
- Every public and protected class/interface must be documented
- Include clear purpose statement
- Include @since tag with version information

[... essential requirements extracted from source ...]

### Testing Standards
Source: ./standards/testing/core-standards.adoc
Last Synced: 2025-10-22

- JUnit 5 only (no Mockito, PowerMock, Hamcrest)
- Minimum 80% coverage overall
- Critical paths need 100% coverage
----

==== Essential Rules Components

Each Essential Rules block must contain:

. **Section Header**: Domain-specific (e.g., "JavaDoc Standards", "Testing Standards")
. **Source Citation**: Relative path to standards file (starts with `./`)
. **Last Synced Date**: ISO format date (YYYY-MM-DD)
. **Core Requirements**: Essential rules extracted from source (simplified for performance)

==== How to Create Essential Rules (Manual Process)

**Step 1: Identify Core Requirements**

1. Read the source standards file (e.g., `standards/documentation/javadoc-standards.adoc`)
2. Extract ONLY the most critical, non-negotiable rules
3. Simplify language - remove examples, rationale, edge cases
4. Focus on "MUST" requirements, not "SHOULD" recommendations

**Step 2: Format as Essential Rules Block**

[source,markdown]
----
## ESSENTIAL RULES

### JavaDoc Standards
Source: ./standards/documentation/javadoc-standards.adoc
Last Synced: 2025-10-22

**Package Documentation**:
- Every package must have package-info.java
- Package documentation must describe the package purpose

**Class/Interface Documentation**:
- Every public and protected class/interface must be documented
- Include clear purpose statement
- Include @since tag with version information
----

**Step 3: Embed in Agent File**

Paste the formatted block into the agent `.md` file, typically after the YAML frontmatter and before the main instructions.

**Step 4: Test Agent**

Verify the agent can read and apply the embedded rules.

==== Maintaining Essential Rules

The `/agents-doctor sync` command (custom implementation) helps maintain synchronization:

* Detects Essential Rules blocks by looking for `Source:` and `Last Synced:` markers
* Reads source standards file and compares with embedded content
* Reports drift if content differs
* **Requires manual approval** to update embedded rules
* Updates `Last Synced` date after approved changes

=== Skills Reference in Agents

Agents should reference skills for complete standards:

[source,markdown]
----
## STANDARDS COMPLIANCE

**Before fixing any code, READ these skills for current, complete standards:**
- `cui-java-standards` skill - Java coding, Javadoc, null-safety
- `cui-testing-methodology` skill - Test coverage requirements
- `cui-process-standards` skill - Pre-commit checklist

The Essential Rules above are core requirements. For complete standards
and edge cases, consult the skills.
----

=== Example: Project Builder Agent

[source,yaml]
----
---
name: project-builder
description: Use this agent when the user needs to build and verify the entire project with quality checks. This agent should be used proactively after code changes are made to ensure the project still compiles and passes all quality gates.
tools: Read, Edit, Write, Bash
model: sonnet
color: green
---
----

Agent combines:

. **Essential Rules**: Embedded JavaDoc, testing, logging requirements
. **Skill References**: Points to skills for complete standards
. **Workflow**: Detailed task execution steps
. **Tool Access**: Read, Edit, Write, Bash for full build verification

== Command Specifications

=== Command Structure

Commands are user-invoked utilities for verification and management.

==== File Format

* **File**: `command-name.md`
* **Location**: `commands/command-name.md`
* **Format**: Markdown with optional YAML frontmatter

==== YAML Frontmatter

Commands use YAML frontmatter to define metadata and configuration.

**All fields are optional** (commands can have no frontmatter).

**Common fields**:

* **description**: Brief description of command purpose
* **allowed-tools**: Comma-separated list (e.g., `Read, Write, Edit, Bash`)
* **argument-hint**: Parameter hint shown in help (e.g., `"[project|global|name]"`)
* **model**: Specific model to use (e.g., `sonnet`, `haiku`)
* **disable-model-invocation**: Set to `true` for pure text commands

**Example**:
[source,yaml]
----
---
description: Brief description of command purpose
allowed-tools: Read, Write, Edit, Bash
argument-hint: "[project|global|agent-name]"
model: sonnet
---
----

For field specifications shared across components, see xref:#yaml-frontmatter-common-fields[Common YAML Frontmatter Fields].

==== Parameter Support

Commands support parameters via:

* `$ARGUMENTS`: All arguments as single string
* `$1`, `$2`, `$3`: Positional parameters
* Bash execution with `!` prefix

=== Example: Agents Doctor Command

[source,markdown]
----
# Agents Doctor - Verify and Fix Agents

Analyze, verify, and fix agents for tool coverage, best practices, and structural issues.

**Architecture Reference**: `./docs/agents-architecture.md`

## PARAMETERS

- **project** (optional): Review all project-specific agents in `.claude/agents/`
- **global** (optional): Review all global agents (from plugin)
- **agent-name** (optional): Review a specific agent by name (e.g., `project-builder`)
- **sync** (optional): Synchronize Essential Rules from standards sources
- **No parameters**: Interactive mode - display menu of all agents and let user select
----

=== Essential Rules Synchronization Command

The `/agents-doctor sync` command updates Essential Rules blocks in agents with current content from source standards files.

**IMPORTANT - Command Semantics**:

* **"sync"** means **one-way update: source → agent** (NOT bidirectional)
* Source standards files are authoritative (never modified by this command)
* Agent Essential Rules blocks are updated to match source
* Changes require explicit user approval (not automatic)

**Why "sync" not "update"?**

* Historical naming convention from similar commands
* Conveys "keeping in synchronization" with source
* Common term in development tools (e.g., `git sync`, `npm sync`)

**What this command does**:

* **Detects** Essential Rules blocks in agents (looks for `Source:` markers)
* **Reads** current standards from source files
* **Compares** embedded content with source content
* **Reports** drift if content differs
* **Proposes** updates where changes detected
* **Requires explicit user approval** for each agent update (NOT automatic)
* **Updates** agent files only after approval
* **Never modifies** source standards files

**Example usage**:
[source,bash]
----
# Check all agents for drift and offer to update
/agents-doctor sync

# Check specific agent only
/agents-doctor sync project-builder

# Alternative phrasing (if supported in future):
/agents-doctor update-essential-rules
----

**Note**: Consider the term "sync" as shorthand for "synchronize embedded rules with source." The direction is always source → agent, never agent → source.

The command provides:

==== Verification Checks

. **Detect Essential Rules blocks**: Find sections with `Source:` and `Last Synced:` markers
. **Verify against source**: Read source file, extract section, compare content
. **Report sync status**:
** UP_TO_DATE: Content matches, sync date recent
** OUT_OF_DATE: Content matches but sync date > 30 days old
** DRIFT_DETECTED: Content differs from source
** SOURCE_MISSING: Source file not found
** NO_SYNC_DATE: Missing `Last Synced` marker

==== Workflow

[source]
----
1. Detect Essential Rules blocks
   - Pattern: ## Essential Rules or ### {Domain} Standards
   - Look for Source: and Last Synced: markers

2. Verify against source
   - Read source file specified in Source: line
   - Extract referenced section (if #section-anchor provided)
   - Compare embedded content with source content
   - Check Last Synced date vs source modification date

3. Report sync status
   - Show status for each Essential Rules block
   - Highlight drift with diff if detected

4. Synchronization workflow
   a. AUTOMATED: Detection, comparison, diff generation
   b. MANUAL REVIEW: Display proposed changes with detailed diff
   c. APPROVAL REQUIRED: User must explicitly approve each agent update
      - Command prompts: "Apply changes to project-builder.md? [y/N]"
      - User types 'y' to approve, any other key to skip
      - No batch approval - each agent reviewed individually
   d. AUTOMATED: After approval:
      - Update embedded Essential Rules content
      - Update Last Synced: date to today (ISO format: YYYY-MM-DD)
      - Write updated agent file
      - Verify write succeeded
   e. AUTOMATED: Summary report of all updates (approved, skipped, failed)

**Rationale for manual approval**: Essential Rules are embedded directly in agent prompts and affect autonomous behavior. Manual review ensures:

* No unintended behavior changes
* Content accuracy before embedding
* User awareness of what agents will execute
* Opportunity to reject breaking changes
----

== Skills Doctor Command

**Status**: Full specification (follows agents-doctor and slash-doctor pattern)

=== Command Definition

**File**: `commands/skills-doctor.md`

**YAML Frontmatter**:
[source,yaml]
----
---
description: Verify and fix skills structure, YAML frontmatter, and cross-references
argument-hint: "[project|global|skill-name]"
allowed-tools: Read, Write, Edit, Bash
---
----

=== Syntax

[source,bash]
----
# Interactive mode (default)
/skills-doctor

# Review all project skills
/skills-doctor project

# Review all global/plugin skills
/skills-doctor global

# Review specific skill
/skills-doctor cui-java-standards
----

=== Parameters

* **No parameters**: Interactive mode - displays menu of all skills for selection
* **project**: Review all skills in `.claude/skills/`
* **global**: Review all skills from plugin installation
* **skill-name**: Review specific skill by name (e.g., `cui-java-standards`)

=== Verification Checks

==== 1. YAML Frontmatter Validation

* Validate YAML syntax (proper `---` delimiters)
* Required fields present: `name`, `description`
* Optional fields valid: `allowed-tools` (comma-separated tool names)
* Field values are non-empty strings

**Reports**:
* ✅ Valid frontmatter
* ❌ Missing required field: `name`
* ❌ Invalid YAML syntax at line X
* ⚠️ Missing recommended field: `description`

==== 2. Standards References Verification

* Find all references to `standards/` files in SKILL.md content
* Verify each referenced file exists at specified path
* Check for valid section anchors (if `#section-id` provided)
* Validate relative paths start with `./`

**Reports**:
* ✅ All 4 standards references valid
* ❌ Referenced file not found: `./standards/java/missing.adoc`
* ❌ Section anchor not found: `./standards/java/code.adoc#nonexistent`
* ⚠️ Using absolute path (should be relative): `~/git/cui-llm-rules/standards/...`

==== 3. Structure Validation

* Verify SKILL.md exists and is primary skill file
* Check for supporting directories (templates/, examples/, checklists/)
* Validate directory structure follows conventions
* Check for README.md (optional but recommended)

**Reports**:
* ✅ Valid skill structure
* ❌ Missing required file: SKILL.md
* ⚠️ No templates/ directory (optional)
* ℹ️ Found 3 templates, 2 examples, 1 checklist

==== 4. Tool Restrictions Review

* If `allowed-tools` specified, validate it's appropriate for skill type
* Knowledge skills should typically use Read-only: `allowed-tools: Read`
* Skills needing search should add: `allowed-tools: Read, Grep, Glob`
* Flag skills with write access as potentially inappropriate

**Reports**:
* ✅ Read-only access appropriate for knowledge skill
* ⚠️ Skill has Write access - verify this is intentional
* ℹ️ No tool restrictions specified (inherits all tools)

==== 5. Cross-References Analysis

* Find all agents that reference this skill
* Find all skills referenced by this skill
* Report unused skills (not referenced by any agent)
* Report circular dependencies

**Reports**:
* ✅ Referenced by 3 agents: project-builder, code-reviewer, adoc-review
* ⚠️ Not referenced by any agents (unused skill?)
* ℹ️ References 0 other skills
* ❌ Circular dependency detected: skill-a → skill-b → skill-a

=== Interactive Mode

[source]
----
$ /skills-doctor

Available skills:
  Project (.claude/skills/):
    (none found)

  Plugin (cui-standards):
    1. cui-java-standards          - CUI Java development standards
    2. cui-testing-methodology     - Testing standards and methodology
    3. cui-documentation-standards - Documentation and Javadoc standards
    4. cui-process-standards       - Development process standards

Select skill to verify [1-4, or 'all']: 1

Verifying skill: cui-java-standards

✅ YAML Frontmatter: Valid
   - name: CUI Java Standards
   - description: Provides CUI Java development standards...
   - allowed-tools: Read

✅ Standards References: All valid (4 files)
   - ./standards/java/java-code-standards.adoc
   - ./standards/testing/core-standards.adoc
   - ./standards/documentation/javadoc-standards.adoc
   - ./standards/process/task-completion-standards.adoc

✅ Structure: Valid
   - SKILL.md present
   - README.md present
   - templates/ directory (3 files)
   - examples/ directory (2 files)

✅ Tool Restrictions: Appropriate
   - Read-only access for knowledge skill

✅ Cross-References: Well integrated
   - Referenced by 3 agents: project-builder, code-reviewer, test-generator
   - References 0 other skills (no dependencies)

Summary: ✅ Skill is well-formed and properly integrated
----

=== Fix Workflow

When issues are detected, `/skills-doctor` offers to fix them:

[source]
----
❌ YAML Frontmatter: Missing required field 'name'

Suggested fix:
---
name: CUI Java Standards
description: Provides CUI Java development standards...
---

Apply fix? [y/N]: y
✅ Updated SKILL.md with corrected frontmatter
----

=== Implementation Requirements

* Read skills from `.claude/skills/` (project) and plugin installation (global)
* Parse YAML frontmatter using standard YAML parser
* Use Glob tool to find referenced standards files
* Use Grep tool to find skill references in agent files
* Offer interactive fixes with user approval
* Generate summary report with statistics

== Path Resolution

**All paths must be relative to plugin/repository root and start with `./`**

**Complete requirements**: See xref:plugin-structure.adoc#path-resolution[Plugin Structure § Path Resolution]

**Quick reference**:

* ✅ Correct: `./standards/java/java-code-standards.adoc`
* ❌ Wrong: `~/git/cui-llm-rules/standards/...` (absolute path)
* ❌ Wrong: `standards/java/...` (missing `./` prefix)

== Tool Access Patterns

=== Skills Tool Restrictions

Skills should typically use Read-only access:

[source,yaml]
----
allowed-tools: Read
----

For skills that need to search:

[source,yaml]
----
allowed-tools: Read, Grep, Glob
----

=== Agent Tool Access

Agents can access all tools or specific subset:

[source,yaml]
----
# All tools (inherits from main thread)
tools:

# Specific tools
tools: Read, Edit, Write, Bash

# Full access for complex agents
tools: Read, Edit, Write, Bash, Grep, Glob, Task
----

=== Command Tool Access

Commands can specify allowed tools via frontmatter:

[source,yaml]
----
allowed-tools: Read, Write, Edit, Bash
----

If not specified, commands have full tool access.

== Common YAML Frontmatter Fields

This section documents YAML frontmatter fields shared across Skills, Agents, and Commands to avoid duplication.

=== Required vs. Optional Fields

[cols="2,1,1,1"]
|===
|Field |Skills |Agents |Commands

|**name**
|✅ Required
|✅ Required
|❌ Not used

|**description**
|✅ Required
|✅ Required
|⚠️ Optional

|**allowed-tools**
|⚠️ Optional
|❌ Not used (use `tools`)
|⚠️ Optional

|**tools**
|❌ Not used (use `allowed-tools`)
|⚠️ Optional
|❌ Not used (use `allowed-tools`)

|**model**
|❌ Not supported
|⚠️ Optional
|⚠️ Optional

|**color**
|❌ Not supported
|⚠️ Optional
|❌ Not supported

|**argument-hint**
|❌ Not supported
|❌ Not supported
|⚠️ Optional

|**disable-model-invocation**
|❌ Not supported
|❌ Not supported
|⚠️ Optional
|===

=== Field Specifications

**name** (Skills, Agents):

* Display name or identifier
* Used for references and discovery
* Should be descriptive and unique

**description** (Skills, Agents, Commands):

* Clear description of purpose or when to use
* For Skills/Agents: Triggers auto-activation based on context matching
* For Commands: Shown in help text

**allowed-tools** (Skills, Commands):

* Comma-separated list of tool names
* Restricts tools available to component
* Example: `Read, Grep, Glob`

**tools** (Agents only):

* Comma-separated list of tool names
* If omitted, inherits all tools from main thread
* Example: `Read, Edit, Write, Bash`

**model** (Agents, Commands):

* Specific Claude model to use
* Values: `sonnet`, `haiku`, `opus`, or full model IDs
* If omitted, uses default model

**color** (Agents only):

* Terminal output color for visual identification
* Values: `red`, `green`, `blue`, `yellow`, etc.

**argument-hint** (Commands only):

* Hint text shown in help for command parameters
* Example: `"[project|global|name]"`

**disable-model-invocation** (Commands only):

* Set to `true` for pure text/template commands
* Prevents Claude from processing command content
